<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xml:lang="en-US">
<head profile="http://gmpg.org/xfn/11">
<title>Ruby exit, exit!, SystemExit and at_exit blunder | Big Fast Blog</title>

<link rel="stylesheet" href="/wp-content/themes/hybrid/style.css" type="text/css" media="screen" />
<link rel="author" href="https://plus.google.com/101358683928607234715/posts"/>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="WordPress 3.0.1" />
<meta name="template" content="Hybrid 0.8" />
<link rel="pingback" href="/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Feed" href="http://feeds.feedburner.com/philwhelansblog" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Comments Feed" href="http://feeds.feedburner.com/philwhelansblog" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Ruby exit, exit!, SystemExit and at_exit blunder Comments Feed" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/feed" />
<link rel='stylesheet' id='wp_greet_box_style-css'  href='/wp-content/plugins/wp-greet-box/css/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='rpx_style-css'  href='/wp-content/plugins/rpx/files/style.css' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='/wp-content/plugins/sharebar/js/sharebar.js'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-greet-box/js/functions.js'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-greet-box/js/js-mode.js'></script>
<script type='text/javascript' src='/wp-content/plugins/rpx/files/javascript.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" />
<link rel='index' title='Big Fast Blog' href='/' />
<link rel='start' title='Firefox &#8211; A must have web browser' href='/firefox-a-must-have-web-browser' />
<link rel='prev' title='Colorful Ruby Code In HTML Using CodeRay' href='/syntax-highlight-your-ruby-code-in-html' />
<link rel='next' title='Fluid Feature Rollout For Ruby On Rails' href='/fluid-feature-rollout-for-ruby-on-rails' />
<link rel='shortlink' href='/?p=1657' />
<meta name="description" content="Recently, we hit a problem with Ruby's exit command. If something went horribly wrong and it made no sense for our application to continue in its current state then we would abort with exit 1. We use supervisord to manage processes, so in this case when we exited with exit status of 1, supervisord would assume something went wrong and restart the process for us. Or at least that is what we thought..." />
<meta name="keywords" content="at_exit,exception,exit,process management,rails,rescue,ruby,ruby on rails,supervisord,systemexit" />
<link rel="canonical" href="/ruby-exit-exit-systemexit-and-at_exit-blunder" />
  <link rel="stylesheet" href="/wp-content/plugins/sharebar/css/sharebar.css" type="text/css" media="screen" />
<script type="text/javascript">jQuery(document).ready(function($) { $('.sharebar').sharebar({horizontal:'true',swidth:'65',minwidth:1000,position:'left',leftOffset:20,rightOffset:10}); });</script>

</head>

<body>

<div id="body-container">
  <div id="container">

  <div id="content" class="hfeed content">

    <div id="utility-before-content" class="sidebar utility">

      <div id="text-13" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-before-content .utility -->

      <div id="post-1657" class="hentry post publish post-1 odd author-admin category-ruby-2 post_tag-atexit post_tag-exception post_tag-exit post_tag-process-management post_tag-rails post_tag-rescue post_tag-ruby post_tag-ruby-on-rails-2 post_tag-supervisord post_tag-systemexit">

        <h1 class="post-title entry-title"><a href="/ruby-exit-exit-systemexit-and-at_exit-blunder" title="Ruby exit, exit!, SystemExit and at_exit blunder" rel="bookmark">Ruby exit, exit!, SystemExit and at_exit blunder</a></h1><p class="byline"><span class="byline-prep byline-prep-author">By</span> <span class="author vcard">Phil Whelan</span> <span class="byline-prep byline-prep-published">on</span> <abbr class="published" title="Saturday, September 8th, 2012, 3:25 pm">September 8, 2012</abbr> </p>
        <div class="entry-content">
          <div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://feeds.feedburner.com/philwhelansblog"  rel="nofollow"><img src="/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://feeds.feedburner.com/philwhelansblog" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><ul id="sharebar" style="background:#;border-color:#;">
<li><a href="http://twitter.com/share" class="twitter-share-button" data-count="vertical" data-via="philwhln">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script></li><li><iframe src="http://www.facebook.com/plugins/like.php?href=http://www.bigfastblog.com/ruby-exit-exit-systemexit-and-at_exit-blunder&layout=box_count&show_faces=false&width=60&action=like&colorscheme=light&height=45" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:45px; height:60px;" allowTransparency="true"></iframe></li></ul><ul id="sharebarx">
<li><a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="philwhln">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script></li><li><iframe src="http://www.facebook.com/plugins/like.php?href=http://www.bigfastblog.com/ruby-exit-exit-systemexit-and-at_exit-blunder&layout=button_count&show_faces=false&width=85&action=like&colorscheme=light&height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:85px; height:21px;" allowTransparency="true"></iframe></li></ul><p>Recently, we hit a problem with Ruby&#8217;s &#8220;<a href="http://www.ruby-doc.org/core-1.9.3/Kernel.html#method-i-exit">exit</a>&#8221; command. If something went horribly wrong and it made no sense for our application to continue in its current state then we would abort with &#8220;exit 1&#8243;. We use <a href="http://supervisord.org/">supervisord</a> to manage processes, so in this case when we exited with exit status of 1, <a href="http://supervisord.org/">supervisord</a> would assume something went wrong and restart the process for us. Or at least that is what we thought&#8230;</p>
<p>&#8220;exit 1&#8243; does not actually cause the process to exit, it just raises a <a href="http://www.ruby-doc.org/core-1.9.3/SystemExit.html">SystemExit</a> exception. This is very clearly explained in the <a href="http://www.ruby-doc.org/core-1.9.3/Kernel.html#method-i-exit">documentation</a>. </p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080;font-weight:bold">begin</span>
  exit
  puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">never get here</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">SystemExit</span>
  puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rescued a SystemExit exception</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>
puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">after begin block</span><span style="color:#710">&quot;</span></span>
</pre>
</div>
</div>
<p>In our case, nothing was catching the exception. So what was it?</p>
<p>The other way to handle exits is to run an &#8220;<a href="http://www.ruby-doc.org/core-1.9.3/Kernel.html#method-i-at_exit">at_exit</a>&#8221; block. Ruby runs any &#8220;at_exit&#8221; block when it gets an &#8220;exit&#8221; call, but does not run these with a &#8220;exit!&#8221; call.</p>
<p>Here is what our rather naive at_exit block looked like&#8230;</p>
<div class="CodeRay">
<div class="code">
<pre>at_exit <span style="color:#080;font-weight:bold">do</span>

  <span style="color:#777"># do cleanup</span>

  <span style="color:#777"># now exit for real</span>
  exit

<span style="color:#080;font-weight:bold">end</span>
</pre>
</div>
</div>
<p>This harmless looking piece of code was turning our &#8220;exit 1&#8243; into an &#8220;exit 0&#8243;. When supervisord sees one of its processes exit with a status of zero, it assumes all is good and does not try to restart the process. This is big problem for uptime and a major reason for using a tool like supervisord.</p>
<p>Instead we should be using &#8220;exit!&#8221; if we want to die hard [with a vengeance] and be sure that the process exited with a status of 1 and is restarted by supervisord. This would bypass all SystemExit rescue blocks and at_exit blocks. </p>
<p>Alternatively, and a better solution, is that we never call &#8220;exit&#8221; inside an &#8220;at_exit&#8221; block and we make sure that all SystemExit rescue blocks and at_exit blocks are used with great caution and echo the original exit status when necessary.</p>
<h2>Update</h2>
<p><a href="http://bibwild.wordpress.com/">Jonathan Rochkind</a> made a really great clarification of the exit / at_exit situation in <a href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21913">a comment</a> below. I think it is important to read it.</p>
<h2>Posted in : <a href="/category/ruby-2"> Ruby</a></h2>
                  </div><!-- .entry-content -->

        <p class="entry-meta"><span class="category">Posted in <a href="/category/ruby-2" rel="tag">Ruby</a></span> <span class="post_tag">| Tagged <a href="/tag/at_exit" rel="tag">at_exit</a>, <a href="/tag/exception" rel="tag">exception</a>, <a href="/tag/exit" rel="tag">exit</a>, <a href="/tag/process-management" rel="tag">process management</a>, <a href="/tag/rails" rel="tag">rails</a>, <a href="/tag/rescue" rel="tag">rescue</a>, <a href="/tag/ruby" rel="tag">ruby</a>, <a href="/tag/ruby-on-rails-2" rel="tag">ruby on rails</a>, <a href="/tag/supervisord" rel="tag">supervisord</a>, <a href="/tag/systemexit" rel="tag">systemexit</a></span> | <a class="comments-link" href="/ruby-exit-exit-systemexit-and-at_exit-blunder#comments" title="Comment on Ruby exit, exit!, SystemExit and at_exit blunder">11 Responses</a></p>
      </div><!-- .hentry -->

    <div id="utility-after-singular" class="sidebar utility">

      <div id="text-16" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-after-singular .utility -->

<div id="comments-template">

    <div id="comments">

      <h3 id="comments-number" class="comments-header">11 responses to &#8220;Ruby exit, exit!, SystemExit and at_exit blunder&#8221;</h3>

      <ol class="comment-list">

  <li id="comment-21416" class="comment byuser comment-author-avdi-grimm even thread-even depth-1 comment role-subscriber user-avdi-grimm">

    <a href="https://plus.google.com/104757475552569715504" rel="external nofollow" title="Avdi Grimm"><img alt='Avdi Grimm' src='http://1.gravatar.com/avatar/fea3202718832fe11a0db6bb44a5cc37?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://plus.google.com/104757475552569715504"><a href="https://plus.google.com/104757475552569715504" title="Avdi Grimm" class="url" rel="external nofollow">Avdi Grimm</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Saturday, September 8th, 2012, 9:21 pm">September 8, 2012</abbr> at <abbr class="comment-time" title="Saturday, September 8th, 2012, 9:21 pm">9:21 pm</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21416" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>A good reminder; not enough people understand Ruby&#8217;s process termination system. Incidentally, I prefer `abort(&#8220;Some error message&#8221;)` to `exit(1)`. It sets the exit status to 1, and also sets the error message in the SystemExit exception.</p>
    </div><!-- .comment-text -->

  <ol class='children'>

  <li id="comment-21418" class="comment byuser comment-author-admin bypostauthor odd alt depth-2 comment role-administrator user-admin entry-author">

    <a href="https://www.google.com/profiles/101358683928607234715" rel="external nofollow" title="Phil Whelan"><img alt='Phil Whelan' src='http://1.gravatar.com/avatar/5f357d996da96ccd36d3374e3728bf29?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://www.google.com/profiles/101358683928607234715"><a href="https://www.google.com/profiles/101358683928607234715" title="Phil Whelan" class="url" rel="external nofollow">Phil Whelan</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Saturday, September 8th, 2012, 9:58 pm">September 8, 2012</abbr> at <abbr class="comment-time" title="Saturday, September 8th, 2012, 9:58 pm">9:58 pm</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21418" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>Great tip Avdi! I&#8217;ve not used abort() before.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment -->
  <li id="comment-21574" class="comment even depth-2 comment reader">

    <img alt='Deryl R. Doucette' src='http://0.gravatar.com/avatar/6dadaf9b9c5aab451a2f8de98752946c?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn">Deryl R. Doucette</cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Wednesday, September 12th, 2012, 6:14 am">September 12, 2012</abbr> at <abbr class="comment-time" title="Wednesday, September 12th, 2012, 6:14 am">6:14 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21574" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>Yes, did not know about the abort() either! I&#8217;ve been hardcoding &#8216;exit 255&#8242; in my scripts. Thanks!</p>
    </div><!-- .comment-text -->

  </li><!-- .comment --></ol>
</li><!-- .comment -->
  <li id="comment-21430" class="comment odd alt thread-odd thread-alt depth-1 comment reader">

    <a href="http://bibwild.wordpress.com" rel="external nofollow" title="Jonathan Rochkind"><img alt='Jonathan Rochkind' src='http://0.gravatar.com/avatar/0f50b9a2ad85666d537d39bda49327ee?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="http://bibwild.wordpress.com"><a href="http://bibwild.wordpress.com" title="Jonathan Rochkind" class="url" rel="external nofollow">Jonathan Rochkind</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Sunday, September 9th, 2012, 6:44 am">September 9, 2012</abbr> at <abbr class="comment-time" title="Sunday, September 9th, 2012, 6:44 am">6:44 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21430" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <blockquote><p>at_exit blocks are used with great caution and echo the original exit status when necessary.</p></blockquote>
<p>Any clue on how one would do this, is there any way an &#8220;at_exit&#8221; block can access the &#8216;original exit status&#8217;?</p>
<p>Or wait, is the key thing just that you do not need to and should not call `exit` inside `at_exit` &#8212; at_exit shoudl do it&#8217;s thing without calling `exit`, and then when it&#8217;s done being executed the process will still exit on it&#8217;s own, with the original exit value. Is that right?</p>
    </div><!-- .comment-text -->

  <ol class='children'>

  <li id="comment-21436" class="comment byuser comment-author-admin bypostauthor even depth-2 comment role-administrator user-admin entry-author">

    <a href="https://www.google.com/profiles/101358683928607234715" rel="external nofollow" title="Phil Whelan"><img alt='Phil Whelan' src='http://1.gravatar.com/avatar/5f357d996da96ccd36d3374e3728bf29?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://www.google.com/profiles/101358683928607234715"><a href="https://www.google.com/profiles/101358683928607234715" title="Phil Whelan" class="url" rel="external nofollow">Phil Whelan</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Sunday, September 9th, 2012, 10:12 am">September 9, 2012</abbr> at <abbr class="comment-time" title="Sunday, September 9th, 2012, 10:12 am">10:12 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21436" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>Good question, Jonathan. Yes, I think putting a &#8220;exit&#8221; inside an &#8220;at_exit&#8221; block makes no sense, because the application is already in the process of exiting. Putting an &#8220;exit!&#8221; instead of an &#8220;at_exit&#8221; block should also be avoided. If you have multiple at_exit blocks then this would cause some to run and others not to run, because one of the blocks decided to do this hard exit. It is technically possible to reason about the order in which these &#8220;at_exit&#8221; blocks execute (&#8220;If multiple handlers are registered, they are executed in reverse order of registration&#8221;), but who is going to keep track of this? It makes for better code to avoid &#8220;exit&#8221; or &#8220;exit!&#8221; within &#8220;at_exit&#8221; blocks altogether, especially a soft exit (&#8220;exit&#8221;). It is possible that some code within an at_exit block realizes that a situation has occurred where it needs to hard exit (&#8220;exit!&#8221;), so that nothing else is executed, but I would try to re-engineer the code so that this is not needed.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment -->
  <li id="comment-21437" class="comment byuser comment-author-avdi-grimm odd alt depth-2 comment role-subscriber user-avdi-grimm">

    <a href="https://plus.google.com/104757475552569715504" rel="external nofollow" title="Avdi Grimm"><img alt='Avdi Grimm' src='http://1.gravatar.com/avatar/fea3202718832fe11a0db6bb44a5cc37?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://plus.google.com/104757475552569715504"><a href="https://plus.google.com/104757475552569715504" title="Avdi Grimm" class="url" rel="external nofollow">Avdi Grimm</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Sunday, September 9th, 2012, 10:28 am">September 9, 2012</abbr> at <abbr class="comment-time" title="Sunday, September 9th, 2012, 10:28 am">10:28 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21437" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>You can always find out what the exit status is by looking at the SystemExit exception, which will be found in `$!` (aka `$ERROR_INFO` if you require &#8216;English&#8217;). If I may shamelessly self-promote for a moment, I go into this in depth in <a href="http://exceptionalruby.com" rel="nofollow">Exceptional Ruby</a>.</p>
    </div><!-- .comment-text -->

  <ol class='children'>

  <li id="comment-21438" class="comment byuser comment-author-admin bypostauthor even depth-3 comment role-administrator user-admin entry-author">

    <a href="https://www.google.com/profiles/101358683928607234715" rel="external nofollow" title="Phil Whelan"><img alt='Phil Whelan' src='http://1.gravatar.com/avatar/5f357d996da96ccd36d3374e3728bf29?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://www.google.com/profiles/101358683928607234715"><a href="https://www.google.com/profiles/101358683928607234715" title="Phil Whelan" class="url" rel="external nofollow">Phil Whelan</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Sunday, September 9th, 2012, 10:54 am">September 9, 2012</abbr> at <abbr class="comment-time" title="Sunday, September 9th, 2012, 10:54 am">10:54 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21438" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>Great tip Avdi. I love shameless self-promotions! <img src='/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> </p>
    </div><!-- .comment-text -->

  </li><!-- .comment --></ol>
</li><!-- .comment --></ol>
</li><!-- .comment -->
  <li id="comment-21450" class="comment odd alt thread-even depth-1 comment reader">

    <img alt='Rick Hull' src='http://0.gravatar.com/avatar/af79cb74b6f6ca8f1102e415a3b9c9c2?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn">Rick Hull</cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Sunday, September 9th, 2012, 5:03 pm">September 9, 2012</abbr> at <abbr class="comment-time" title="Sunday, September 9th, 2012, 5:03 pm">5:03 pm</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21450" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>&gt; Yes, I think putting a “exit” inside an “at_exit” block makes no sense</p>
<p>Pardon the phrase, but this is the real WTF.  Maybe at_exit good practices would be a good blog post.  I&#8217;ve never had to use it so I&#8217;ve never looked into it myself.  Also, I wholeheartedly recommend Avdi&#8217;s exceptional book.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment -->
  <li id="comment-21607" class="comment even thread-odd thread-alt depth-1 comment reader">

    <a href="http://japgolly.blogspot.com.au/" rel="external nofollow" title="David Barri"><img alt='David Barri' src='http://0.gravatar.com/avatar/8c6a913c20ee6f2001ce85198b887bac?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="http://japgolly.blogspot.com.au/"><a href="http://japgolly.blogspot.com.au/" title="David Barri" class="url" rel="external nofollow">David Barri</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Thursday, September 13th, 2012, 6:05 am">September 13, 2012</abbr> at <abbr class="comment-time" title="Thursday, September 13th, 2012, 6:05 am">6:05 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21607" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>What a coincidence! I just blogged about something very similar!<br />
<a href="http://japgolly.blogspot.com.au/2012/09/problems-with-atexit-and-exit-and-rspec.html" rel="nofollow">http://japgolly.blogspot.com.au/2012/09/problems-with-atexit-and-exit-and-rspec.html</a></p>
<p>Nice.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment -->
  <li id="comment-21913" class="comment odd alt thread-even depth-1 comment reader">

    <a href="http://bibwild.wordpress.com" rel="external nofollow" title="Jonathan Rochkind"><img alt='Jonathan Rochkind' src='http://0.gravatar.com/avatar/0f50b9a2ad85666d537d39bda49327ee?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="http://bibwild.wordpress.com"><a href="http://bibwild.wordpress.com" title="Jonathan Rochkind" class="url" rel="external nofollow">Jonathan Rochkind</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Wednesday, September 19th, 2012, 9:08 am">September 19, 2012</abbr> at <abbr class="comment-time" title="Wednesday, September 19th, 2012, 9:08 am">9:08 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21913" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>After running into my own weird at_exit related bug, I discovered this MRI bug report:</p>
<p><a href="http://bugs.ruby-lang.org/issues/5218" rel="nofollow">http://bugs.ruby-lang.org/issues/5218</a></p>
<p>I think a LOT of people&#8217;s at_exit related problems are actually due to this bug. Note that while the bug is marked fixed in the tracker, the reproduction still reproduces for me in 1.9.3p194, so I don&#8217;t think it&#8217;s made it into a release yet. </p>
<p>And that bug report reproduction case also reveals something interesting &#8212; you ARE allowed to call `exit` in an `at_exit` block.  It does not keep subsequent  `at_exit` blocks from running. If everything is working properly, the exit code of the last `at_exit` block to call `exit` &#8216;wins&#8217;. But because of that bug, everything may not be working properly.  There is a workaround with monkey-patch redefining `at_exit` in that bug report. </p>
<p>That bug doesn&#8217;t actually account for YOUR problem as above. Your problem was a legitimate software error &#8212; don&#8217;t call &#8216;exit&#8217; in an `at_exit` block unless you actually WANT to set the exit code in the `at_exit` block. If you don&#8217;t, and don&#8217;t need to call `exit` in it, you&#8217;re fine. If you DO need to call `exit&#8217; in an at_exit block to set the exit code&#8230; then the MRI bug may interfere with your desires.</p>
    </div><!-- .comment-text -->

  <ol class='children'>

  <li id="comment-21914" class="comment byuser comment-author-admin bypostauthor even depth-2 comment role-administrator user-admin entry-author">

    <a href="https://www.google.com/profiles/101358683928607234715" rel="external nofollow" title="Phil Whelan"><img alt='Phil Whelan' src='http://1.gravatar.com/avatar/5f357d996da96ccd36d3374e3728bf29?s=80&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://www.google.com/profiles/101358683928607234715"><a href="https://www.google.com/profiles/101358683928607234715" title="Phil Whelan" class="url" rel="external nofollow">Phil Whelan</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Wednesday, September 19th, 2012, 9:43 am">September 19, 2012</abbr> at <abbr class="comment-time" title="Wednesday, September 19th, 2012, 9:43 am">9:43 am</abbr></span> | <a class="permalink" href="/ruby-exit-exit-systemexit-and-at_exit-blunder/comment-page-1#comment-21914" title="Permalink to comment ">Permalink</a>  </div>
    <div class="comment-text">

      <p>Thanks Jonathan for this great clarification! I think anyone who reads this post should read your comment. I will make a note of it at the bottom of the post.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment --></ol>
</li><!-- .comment -->      </ol><!-- .comment-list -->

              <div class="comment-navigation paged-navigation">
                  </div><!-- .comment-navigation -->

    </div><!-- #comments -->

</div><!-- #comments-template -->

    <div class="navigation-links">
      <a href="/syntax-highlight-your-ruby-code-in-html" rel="prev"><span class="previous">&laquo; Previous</span></a>      <a href="/fluid-feature-rollout-for-ruby-on-rails" rel="next"><span class="next">Next &raquo;</span></a>    </div><!-- .navigation-links -->

  </div><!-- .content .hfeed -->

  <div id="primary" class="sidebar aside">

        <div id="popularity-lists-1" class="widget widget_popularity_lists widget-widget_popularity_lists"><div class="widget-inside">      <h3 class="widget-title">Top Posts</h3>      <ul>
      <li><a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew - Intro To The Mac OS X Package Installer</a></li><li><a href="/quoras-technology-examined">Quora's Technology Examined</a></li><li><a href="/gitolite-installation-step-by-step">Gitolite Installation Step-By-Step</a></li><li><a href="/how-to-get-experience-working-with-large-datasets">How To Get Experience Working With Large Datasets</a></li><li><a href="/install-gitolite-to-manage-your-git-repositories">Install Gitolite To Manage Your Git Repositories</a></li><li><a href="/embed-base64-encoded-images-inline-in-html">Embed Base64-Encoded Images Inline In HTML</a></li><li><a href="/map-reduce-with-ruby-using-hadoop">Map-Reduce With Ruby Using Hadoop</a></li><li><a href="/highchart-vs-flot-js-comparing-javascript-graphing-engines">Highchart Vs Flot.js - Comparing JavaScript Graphing Engines </a></li>      </ul>
    </div></div><div id="hybrid-tags-2" class="widget tags widget-tags"><div class="widget-inside"><h3 class="widget-title">Tags</h3><p class="post_tag-cloud term-cloud"><a href='/tag/amazon-ec2' class='tag-link-211' title='6 topics' style='font-size: 15.194444444444pt;'>amazon ec2</a> <a href='/tag/android' class='tag-link-74' title='2 topics' style='font-size: 8pt;'>android</a> <a href='/tag/apple' class='tag-link-20' title='3 topics' style='font-size: 10.333333333333pt;'>apple</a> <a href='/tag/cassandra' class='tag-link-204' title='3 topics' style='font-size: 10.333333333333pt;'>cassandra</a> <a href='/tag/customers-2' class='tag-link-148' title='2 topics' style='font-size: 8pt;'>customers</a> <a href='/tag/data-processing-2' class='tag-link-107' title='5 topics' style='font-size: 13.833333333333pt;'>data processing</a> <a href='/tag/entrepreneur' class='tag-link-123' title='2 topics' style='font-size: 8pt;'>entrepreneur</a> <a href='/tag/entrepreneurship' class='tag-link-117' title='2 topics' style='font-size: 8pt;'>entrepreneurship</a> <a href='/tag/eventmachine-2' class='tag-link-422' title='3 topics' style='font-size: 10.333333333333pt;'>eventmachine</a> <a href='/tag/gem' class='tag-link-274' title='3 topics' style='font-size: 10.333333333333pt;'>gem</a> <a href='/tag/git' class='tag-link-177' title='3 topics' style='font-size: 10.333333333333pt;'>git</a> <a href='/tag/gitolite' class='tag-link-178' title='2 topics' style='font-size: 8pt;'>gitolite</a> <a href='/tag/google' class='tag-link-89' title='2 topics' style='font-size: 8pt;'>google</a> <a href='/tag/hadoop' class='tag-link-102' title='7 topics' style='font-size: 16.166666666667pt;'>hadoop</a> <a href='/tag/hbase' class='tag-link-264' title='4 topics' style='font-size: 12.277777777778pt;'>hbase</a> <a href='/tag/hdfs' class='tag-link-103' title='4 topics' style='font-size: 12.277777777778pt;'>hdfs</a> <a href='/tag/high-scalability' class='tag-link-114' title='3 topics' style='font-size: 10.333333333333pt;'>high scalability</a> <a href='/tag/homebrew' class='tag-link-216' title='4 topics' style='font-size: 12.277777777778pt;'>homebrew</a> <a href='/tag/install' class='tag-link-51' title='2 topics' style='font-size: 8pt;'>install</a> <a href='/tag/iphone' class='tag-link-65' title='2 topics' style='font-size: 8pt;'>iphone</a> <a href='/tag/java' class='tag-link-276' title='3 topics' style='font-size: 10.333333333333pt;'>java</a> <a href='/tag/location' class='tag-link-136' title='2 topics' style='font-size: 8pt;'>location</a> <a href='/tag/mac-osx' class='tag-link-59' title='2 topics' style='font-size: 8pt;'>mac osx</a> <a href='/tag/memcached' class='tag-link-306' title='4 topics' style='font-size: 12.277777777778pt;'>memcached</a> <a href='/tag/mongodb' class='tag-link-210' title='5 topics' style='font-size: 13.833333333333pt;'>mongodb</a> <a href='/tag/mysql' class='tag-link-293' title='3 topics' style='font-size: 10.333333333333pt;'>mysql</a> <a href='/tag/nginx' class='tag-link-326' title='4 topics' style='font-size: 12.277777777778pt;'>nginx</a> <a href='/tag/nosql' class='tag-link-205' title='6 topics' style='font-size: 15.194444444444pt;'>nosql</a> <a href='/tag/perl' class='tag-link-377' title='3 topics' style='font-size: 10.333333333333pt;'>perl</a> <a href='/tag/phone' class='tag-link-72' title='3 topics' style='font-size: 10.333333333333pt;'>phone</a> <a href='/tag/postgresql' class='tag-link-221' title='3 topics' style='font-size: 10.333333333333pt;'>postgresql</a> <a href='/tag/python' class='tag-link-355' title='5 topics' style='font-size: 13.833333333333pt;'>python</a> <a href='/tag/rails' class='tag-link-172' title='2 topics' style='font-size: 8pt;'>rails</a> <a href='/tag/redis' class='tag-link-301' title='3 topics' style='font-size: 10.333333333333pt;'>redis</a> <a href='/tag/ruby' class='tag-link-166' title='15 topics' style='font-size: 22pt;'>ruby</a> <a href='/tag/ruby-on-rails-2' class='tag-link-157' title='6 topics' style='font-size: 15.194444444444pt;'>ruby on rails</a> <a href='/tag/scala' class='tag-link-302' title='3 topics' style='font-size: 10.333333333333pt;'>scala</a> <a href='/tag/ssh-keygen' class='tag-link-180' title='2 topics' style='font-size: 8pt;'>ssh-keygen</a> <a href='/tag/startup' class='tag-link-119' title='3 topics' style='font-size: 10.333333333333pt;'>startup</a> <a href='/tag/tornado' class='tag-link-330' title='6 topics' style='font-size: 15.194444444444pt;'>tornado</a> <a href='/tag/twitter' class='tag-link-133' title='2 topics' style='font-size: 8pt;'>twitter</a> <a href='/tag/vancouver' class='tag-link-120' title='2 topics' style='font-size: 8pt;'>vancouver</a> <a href='/tag/web-development-2' class='tag-link-193' title='5 topics' style='font-size: 13.833333333333pt;'>web-development</a> <a href='/tag/whirr' class='tag-link-223' title='3 topics' style='font-size: 10.333333333333pt;'>whirr</a> <a href='/tag/wikipedia' class='tag-link-174' title='2 topics' style='font-size: 8pt;'>wikipedia</a></p></div></div>

  </div><!-- #primary .aside -->

  </div><!-- #container -->

  <div id="footer-container">

    <div id="footer">

      <small>Copyright &#169; 2016 <a class="site-link" href="/" title="Big Fast Blog" rel="home"><span>Big Fast Blog</span></a> | Vancouver, BC, Canada</small>
    </div><!-- #footer -->

  </div><!-- #footer-container -->

</div><!-- #body-container -->

</body>
</html>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15826070-1', 'auto');
  ga('send', 'pageview');

</script>
