<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xml:lang="en-US">
<head profile="http://gmpg.org/xfn/11">
<title>Landsliding Into PostGIS With KML Files | Big Fast Blog</title>

<link rel="stylesheet" href="/wp-content/themes/hybrid/style.css" type="text/css" media="screen" />
<link rel="author" href="https://plus.google.com/101358683928607234715/posts"/>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="WordPress 3.0.1" />
<meta name="template" content="Hybrid 0.8" />
<link rel="pingback" href="/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Feed" href="http://feeds.feedburner.com/philwhelansblog" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Comments Feed" href="http://feeds.feedburner.com/philwhelansblog" />
<link rel='stylesheet' id='wp_greet_box_style-css'  href='/wp-content/plugins/wp-greet-box/css/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='rpx_style-css'  href='/wp-content/plugins/rpx/files/style.css' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='/wp-content/plugins/sharebar/js/sharebar.js'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-greet-box/js/functions.js'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-greet-box/js/js-mode.js'></script>
<script type='text/javascript' src='/wp-content/plugins/rpx/files/javascript.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" />
<link rel='index' title='Big Fast Blog' href='/' />
<link rel='start' title='Firefox &#8211; A must have web browser' href='/firefox-a-must-have-web-browser' />
<link rel='prev' title='Embed Base64-Encoded Images Inline In HTML' href='/embed-base64-encoded-images-inline-in-html' />
<link rel='next' title='The Apache Projects &#8211; The Justice League Of Scalability' href='/the-apache-projects-the-justice-league-of-scalability' />
<link rel='shortlink' href='/?p=665' />
<meta name="description" content="In this post I will show, in repeatable steps, how to install PostGIS, load in geospatial data found in a KML file and run queries against that data. The focus of this geospatial data will be landslides and our resulting database will allow us to query, using longitude and latitude co-ordinates, the landslide status of a specific geographical point." />
<meta name="keywords" content="esri shapefile,gdal,geo,geographic,geospatial,gis,homebrew,kml,kmz,landslides,latitude,libkml,longitude,macosx,ogr2ogr,postgis,postgresql,shapefile,shp,sql" />
<link rel="canonical" href="/landsliding-into-postgis-with-kml-files" />
  <link rel="stylesheet" href="/wp-content/plugins/sharebar/css/sharebar.css" type="text/css" media="screen" />
<script type="text/javascript">jQuery(document).ready(function($) { $('.sharebar').sharebar({horizontal:'true',swidth:'65',minwidth:1000,position:'left',leftOffset:20,rightOffset:10}); });</script>

</head>

<body class="sunday not-logged-in singular singular-post singular-post-665 single-665 primary-active secondary-inactive subsidiary-inactive">

<div id="body-container">

  <div id="header-container">

    <div id="header">

      <a href="/"><img src="http://commondatastorage.googleapis.com/philwhln/blog/images/big_fast_blog_title5.png" width="650" height="191" Alt="Phil Whelan's Big Fast Blog" border="0"></a>

    </div><!-- #header -->

  </div><!-- #header-container -->

  <div id="navigation">
      <div id="page-nav" class="page-nav"></div>
  </div><!-- #navigation -->

  <div id="container">

  <div id="content" class="hfeed content">

    <div id="utility-before-content" class="sidebar utility">

      <div id="text-13" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-before-content .utility -->

      <div id="post-665" class="hentry post publish post-1 odd author-admin category-geospatial category-postgis category-software-development post_tag-esri-shapefile post_tag-gdal post_tag-geo post_tag-geographic post_tag-geospatial-2 post_tag-gis post_tag-homebrew post_tag-kml post_tag-kmz post_tag-landslides post_tag-latitude post_tag-libkml post_tag-longitude post_tag-macosx post_tag-ogr2ogr post_tag-postgis-2 post_tag-postgresql post_tag-shapefile post_tag-shp post_tag-sql">

        <h1 class="post-title entry-title"><a href="/landsliding-into-postgis-with-kml-files" title="Landsliding Into PostGIS With KML Files" rel="bookmark">Landsliding Into PostGIS With KML Files</a></h1><p class="byline"><span class="byline-prep byline-prep-author">By</span> <span class="author vcard">Phil Whelan</span> <span class="byline-prep byline-prep-published">on</span> <abbr class="published" title="Wednesday, January 5th, 2011, 9:25 am">January 5, 2011</abbr> </p>
        <div class="entry-content">
          <div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://feeds.feedburner.com/philwhelansblog"  rel="nofollow"><img src="/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://feeds.feedburner.com/philwhelansblog" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><ul id="sharebar" style="background:#;border-color:#;">
<li><a href="http://twitter.com/share" class="twitter-share-button" data-count="vertical" data-via="philwhln">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script></li><li><iframe src="http://www.facebook.com/plugins/like.php?href=http://www.bigfastblog.com/landsliding-into-postgis-with-kml-files&layout=box_count&show_faces=false&width=60&action=like&colorscheme=light&height=45" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:45px; height:60px;" allowTransparency="true"></iframe></li></ul><ul id="sharebarx">
<li><a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="philwhln">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script></li><li><iframe src="http://www.facebook.com/plugins/like.php?href=http://www.bigfastblog.com/landsliding-into-postgis-with-kml-files&layout=button_count&show_faces=false&width=85&action=like&colorscheme=light&height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:85px; height:21px;" allowTransparency="true"></iframe></li></ul><p><a href="http://www.flickr.com/photos/hitchster/2871036863/" title="Landslide damaged roadway (2005) by Hitchster, on Flickr"><img src="/wp-content/uploads/2011/01/postgis_kml.jpg" width="235" height="313" alt="Landslide damaged roadway (2005)" align="left" style="border: none; margin-right: 20px" /></a></p>
<p>In this post I will show, in repeatable steps, how to install <a href="http://postgis.refractions.net/">PostGIS</a>, load in geospatial data found in a <a href="http://en.wikipedia.org/wiki/Keyhole_Markup_Language">KML</a> file and run queries against that data. The focus of this geospatial data will be landslides and our resulting database will allow us to query, using longitude and latitude co-ordinates, the landslide status of a specific geographical point. The returned status for the given co-ordinates will be &#8220;Mostly Landslides&#8221;, &#8220;Few Landslides&#8221;,  &#8220;Flat Land&#8221;, &#8220;Not Mapped&#8221;.</p>
<h2>KML / KMZ Files</h2>
<p>KML files define, in XML, geographical data in three dimensions. A <em>KMZ</em> file is simply a zipped KML file.</p>
<p>You can find many weird and wonderful KML files on the Internet, either via <a href="http://www.google.ca/search?q=kml+files">Google Search</a> or via <a  href="http://www.google.com/gadgets/directory?synd=earth&#038;cat=featured&#038;preview=on">Google Earth Gallery</a>.</p>
<blockquote><p><strong>Keyhole Markup Language (KML)</strong> is an XML schema for expressing geographic annotation and visualization within Internet-based, two-dimensional maps and three-dimensional Earth browsers. KML was developed for use with Google Earth, which was originally named Keyhole Earth Viewer. It was created by Keyhole, Inc, which was acquired by Google in 2004. The name &#8220;Keyhole&#8221; is an homage to the KH reconnaissance satellites, the original eye-in-the-sky military reconnaissance system first launched in 1976. KML is an international standard of the Open Geospatial Consortium. Google Earth was the first program able to view and graphically edit KML files.<br /> &#8211; <a href="http://en.wikipedia.org/wiki/Keyhole_Markup_Language">KML Wikipedia</a></p></blockquote>
<h2>PostGIS</h2>
<p><a href="http://postgis.refractions.net/">PostGIS</a> is the number one architecture for dealing with geospatial data within a relational database. It works within PostgreSQL.</p>
<p>While working with <a href="http://www.netsign.com">netSIGN</a> I had the opportunity to work briefly with PostGIS, which provides support for geographic objects within PostgreSQL. In that instance I was precisely identifying real-estate locations from longitude and latitude co-ordinates using <a href="http://data.vancouver.ca/datacatalogue/localAreaBoundary.htm">The City Of Vancouver&#8217;s Area Boundary KML file</a>. This time we will be looking at <a href="http://earthquake.usgs.gov/regional/nca/bayarea/landslides.php">San Francisco Bay-Area Landslides</a>.</p>
<h3>Installing PostGIS</h3>
<p>On Mac OS X you can install both PostGIS, and it&#8217;s dependency PostgreSQL, with <a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew</a>. For simplicity we assume that you already have PostgreSQL installed. </p>
<pre>sudo brew install postgis</pre>
<h3>Configuring PostGIS</h3>
<p>Login as the <em>postgres</em> user.</p>
<pre>sudo su postgres</pre>
<h3>Create A PostGIS Template Database</h3>
<p>Now we will create a template database for PostGIS within PostgreSQL from which we can create our own PostGIS database.</p>
<pre>
TEMPLATE_DB_NAME=template_postgis

# Create the template spatial database.
createdb -E UTF8 $TEMPLATE_DB_NAME

# Add PLPGSQL language support.
createlang -d $TEMPLATE_DB_NAME plpgsql

# Load the PostGIS extensions
for SQL_NAME in postgis postgis_comments spatial_ref_sys
do
    psql -d $TEMPLATE_DB_NAME -f /usr/local/Cellar/postgis/1.5.2/share/postgis/$SQL_NAME.sql
done

# Finalize our PostGIS template database
cat &lt;&lt;EOS | psql -d $TEMPLATE_DB_NAME
UPDATE pg_database SET datistemplate = TRUE WHERE datname = '$TEMPLATE_DB_NAME';
REVOKE ALL ON SCHEMA public FROM public;
GRANT USAGE ON SCHEMA public TO public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT SELECT, UPDATE, INSERT, DELETE ON TABLE public.geometry_columns TO PUBLIC;
GRANT SELECT, UPDATE, INSERT, DELETE ON TABLE public.spatial_ref_sys TO PUBLIC;
VACUUM FULL FREEZE;
EOS
</pre>
<h3>Create The Database From The Template</h3>
<pre>
DB_NAME="landslide_db"
DB_USER="landslide_user"

createuser --no-superuser --createdb --no-createrole $DB_USER
createdb --template=template_postgis --encoding=UTF8 --owner=$DB_USER $DB_NAME
echo "GRANT ALL ON SCHEMA public TO $DB_USER" | psql $DB_NAME
for t in geography_columns geometry_columns spatial_ref_sys
do
    echo "ALTER TABLE $t OWNER TO $DB_USER" | psql -d $DB_NAME
done
</pre>
<h2>Preparing The Geospatial Data For PostGIS</h2>
<p>I will use some test data from <a href="http://earthquake.usgs.gov/regional/nca/bayarea/landslides.php">San Francisco Bay-Area Landslides</a>. From <a href="http://earthquake.usgs.gov">earthquake.usgs.gov</a> we can download a <a href="http://earthquake.usgs.gov/regional/nca/bayarea/kml/landslides.kmz">KMZ file</a> which contains the geographic information, in the form of 2-D polygons, of the landslide areas.</p>
<pre>wget http://earthquake.usgs.gov/regional/nca/bayarea/kml/landslides.kmz</pre>
<h3>Converting KML File To ESRI Shapefile Using Ogr2ogr</h3>
<p>We need to install the <em>ogr2ogr</em> command-line conversion tool. This is included with <a href="http://www.gdal.org/">gdal</a> and <a href="http://fwtools.maptools.org/">FWTools</a>. If you install <em>gdal-bin</em> on Linux via <em>apt-get</em> then you will probably get an older version that does not decode KML 2.2 files (required in this example). I recommend building <a href="http://trac.osgeo.org/gdal/wiki/DownloadSource">gdal-bin from source</a> on Linux.</p>
<p>On my Mac I will install gdal, and hence ogr2ogr, using <a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew</a>.</p>
<p>We first have to install <a href="http://code.google.com/p/libkml/">libkml</a>, which is dependency of gdal if we want read KML 2.2 files. libkml is a KML file parsing engine written by Google and is used in Google Earth and Google Maps. Ogr2ogr can use libkml to read the KML files. It does have it&#8217;s own KML parser, but that will not work with the KML 2.2 file we will try to convert and generally is not as good as libkml at reading KML files. Usually, I would install libkml using <a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew</a>, but I found that you can only install libkml 1.2 and gdal 1.8.0beta1 requires libkml 1.3. Therefore, I will install libkml from the libkml source respository, which is currently only way to get libkml 1.3.</p>
<pre><del datetime="2011-01-04T05:32:29+00:00">sudo brew install libkml</del> # only version 1.2

svn checkout http://libkml.googlecode.com/svn/trunk libkml # currently version 1.3
cd libkml
./autogen.sh
./configure
make
sudo make install
</pre>
<p>That&#8217;s libkml installed. Now, let&#8217;s use <a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew</a> to install the latest version of gdal.</p>
<pre>sudo brew install gdal --HEAD --complete</pre>
<p>I use <em>&#8211;complete</em> to install all the additional file format parsers.</p>
<p><em>&#8211;HEAD</em> is used to download the latest version from the gdal Subversion repository. I use &#8211;HEAD because, as of writing this, the current stable version is 1.7.3 and it does not provide libkml support, which is needed to read KML 2.2 files. The current version in Subversion is 1.8.0beta1.</p>
<p>Now the <em>ogr2ogr</em> conversion utility should be installed. KMZ is a zipped KML file. It is just a regular zip file, so we can unzip this by simply using the unzip command. libkml does recognize the kmz extension, so we would not usually need to do this step, but landslides.kmz does not contain the data we want, only references to it via several <a href="http://code.google.com/apis/kml/documentation/kml_tut.html#network_links">NetworkLinks</a> to other KMZ files.  </p>
<pre>unzip landslides.kmz</pre>
<p><small>If you have problems unzip a .kmz file, then simply rename to have a .zip extension</small></p>
<p>When we unzip landslides.kmz, we find it contains only one file called <em>doc.kml</em>. Here is a what the doc.kml looks like&#8230;</p>
<p><small>
<pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom"&gt;
&lt;Document&gt;
  &lt;name&gt;Landslides&lt;/name&gt;
  &lt;LookAt&gt;
    &lt;longitude&gt;-122.2499999599815&lt;/longitude&gt;
    &lt;latitude&gt;37.62500001065743&lt;/latitude&gt;
    &lt;altitude&gt;0&lt;/altitude&gt;
    &lt;range&gt;413167.7811227545&lt;/range&gt;
    &lt;tilt&gt;0&lt;/tilt&gt;
    &lt;heading&gt;2.443095370245979e-008&lt;/heading&gt;
    &lt;altitudeMode&gt;relativeToGround&lt;/altitudeMode&gt;
  &lt;/LookAt&gt;
  &lt;Style&gt;
    &lt;ListStyle&gt;
      &lt;listItemType&gt;checkHideChildren&lt;/listItemType&gt;
      &lt;bgColor&gt;00ffffff&lt;/bgColor&gt;
      &lt;maxSnippetLines&gt;2&lt;/maxSnippetLines&gt;
    &lt;/ListStyle&gt;
  &lt;/Style&gt;
  &lt;NetworkLink id="1"&gt;
    &lt;name&gt;Aetna_Springs&lt;/name&gt;
    &lt;Region&gt;
      &lt;LatLonAltBox&gt;
        &lt;north&gt;38.75&lt;/north&gt;
        &lt;south&gt;38.625&lt;/south&gt;
        &lt;east&gt;-122.375&lt;/east&gt;
        &lt;west&gt;-122.5&lt;/west&gt;
        &lt;minAltitude&gt;0&lt;/minAltitude&gt;
        &lt;maxAltitude&gt;0&lt;/maxAltitude&gt;
      &lt;/LatLonAltBox&gt;
      &lt;Lod&gt;
        &lt;minLodPixels&gt;450&lt;/minLodPixels&gt;
        &lt;maxLodPixels&gt;-1&lt;/maxLodPixels&gt;
        &lt;minFadeExtent&gt;128&lt;/minFadeExtent&gt;
        &lt;maxFadeExtent&gt;128&lt;/maxFadeExtent&gt;
      &lt;/Lod&gt;
    &lt;/Region&gt;
    &lt;Link&gt;
      <strong>&lt;href&gt;http://earthquake.usgs.gov/regional/nca/bayarea/kml/Landslides/Landslides_Aetna_Springs.kmz&lt;/href&gt;</strong>
      &lt;ViewRefreshMode&gt;onRegion&lt;/ViewRefreshMode&gt;
    &lt;/Link&gt;
  &lt;/NetworkLink&gt;
  &lt;NetworkLink id="2"&gt;
    &lt;name&gt;Allendale&lt;/name&gt;
    &lt;Region&gt;
      &lt;LatLonAltBox&gt;
        &lt;north&gt;38.5&lt;/north&gt;
        &lt;south&gt;38.375&lt;/south&gt;
        &lt;east&gt;-121.875&lt;/east&gt;
        &lt;west&gt;-122&lt;/west&gt;
        &lt;minAltitude&gt;0&lt;/minAltitude&gt;
        &lt;maxAltitude&gt;0&lt;/maxAltitude&gt;
      &lt;/LatLonAltBox&gt;
      &lt;Lod&gt;
        &lt;minLodPixels&gt;450&lt;/minLodPixels&gt;
        &lt;maxLodPixels&gt;-1&lt;/maxLodPixels&gt;
        &lt;minFadeExtent&gt;128&lt;/minFadeExtent&gt;
        &lt;maxFadeExtent&gt;128&lt;/maxFadeExtent&gt;
      &lt;/Lod&gt;
    &lt;/Region&gt;
    &lt;Link&gt;
      <strong>&lt;href&gt;http://earthquake.usgs.gov/regional/nca/bayarea/kml/Landslides/Landslides_Allendale.kmz&lt;/href&gt;</strong>
      &lt;ViewRefreshMode&gt;onRegion&lt;/ViewRefreshMode&gt;
    &lt;/Link&gt;
  &lt;/NetworkLink&gt;
  &lt;NetworkLink id="3"&gt;
    &lt;name&gt;Altamont&lt;/name&gt;
    &lt;Region&gt;
      &lt;LatLonAltBox&gt;
        &lt;north&gt;37.75&lt;/north&gt;
        &lt;south&gt;37.625&lt;/south&gt;
</pre>
<p></small></p>
<p>Yes, KML is XML.</p>
<p>You will notice several &lt;NetworkLink&gt; blocks that contain a &lt;Link&gt; block that contains &lt;href&gt; tags that contain a web link to another KMZ file. Ideally these would be sucked in libkml when we parse the KML/KMZ file, but as Google says in it&#8217;s documentation&#8230;</p>
<blockquote><p>In their simplest form, network links are a useful way to split one large KML file into smaller, more manageable files on the same computer.</p>
<p>Despite the name, a &lt;NetworkLink&gt; does not necessarily load files from the network.</p>
<p><small><a href="http://code.google.com/apis/kml/documentation/kml_tut.html#network_links"> &#8211; Courtesy of Google&#8217;s KML documentation</a></small></p></blockquote>
<p>For this example, I&#8217;m just going to grab the first of these referenced KMZ files, <a href="http://earthquake.usgs.gov/regional/nca/bayarea/kml/Landslides/Landslides_Aetna_Springs.kmz">Landslides_Aetna_Springs.kmz</a>.</p>
<p>We will first convert this KMZ into a ESRI Shapefile using ogr2ogr.</p>
<pre>ogr2ogr -f "ESRI Shapefile" landslides.shp Landslides_Aetna_Springs.kmz</pre>
<p>Although, we got a few warnings, we did get our shapefile (actually, several files).</p>
<pre>Warning 6: Normalized/laundered field name: 'description' to 'descriptio'
Warning 6: Field timestamp create as date field, though DateTime requested.

Warning 6: Field begin create as date field, though DateTime requested.

Warning 6: Field end create as date field, though DateTime requested.

Warning 6: Normalized/laundered field name: 'altitudeMode' to 'altitudeMo'
</pre>
<p>The ESRI Shapefile comprises of these files, although we usually only need to reference the .shp file.</p>
<pre>landslides.shp
landslides.shx
landslides.prj
landslides.dbf
</pre>
<h3>Converting ESRI Shapefile To SQL Using Shp2pgsql</h3>
<p>Since PostGIS runs inside PostgreSQL, we are going need some SQL, so I will convert that ESRI Shapefile to SQL using the <em>shp2pgsql</em> command-line tool. The <em>shp2pgsql</em> tool comes with the PostGIS install, so you can run this from anywhere that you have installed PostGIS.</p>
<pre>shp2pgsql -s 4326 -I -c -W UTF-8 landslides.shp landslides &gt; landslides.sql</pre>
<p>This generates <em>landslide.sql</em> which contains the geolocation data from Landslides_Aetna_Springs.kmz as SQL statements.</p>
<p>-s specifies the SRID field. Since Google Maps uses SRID 4326 (&#8220;WGS84&#8243;) for this, we will use the same.</p>
<blockquote><p>A Spatial Reference System Identifier (SRID) is a unique value used to unambiguously identify projected, unprojected, and local spatial coordinate system definitions. These coordinate systems form the heart of all GIS applications.<br /><small><a href="http://en.wikipedia.org/wiki/SRID"> &#8211; Wikipedia</a></small>
</p></blockquote>
<p>We also specifiy <em>landslides</em> as the name of database table that we will be inserting into. landslides.sql will contain a create table statement using this name and the subsequent INSERT statements within landslides.sql will insert into this table.</p>
<p>Here are the other options I have used for the <em>shp2pgsql</em> command.</p>
<p><small></p>
<table>
<tr>
<td style="width: 30px">-c</td>
<td>Creates a new table and populates it, this is the default if you do not specify any options.</td>
</tr>
<tr>
<td>-I</td>
<td>Create a spatial index on the geocolumn.</td>
</tr>
<tr>
<td>-S</td>
<td>Generate simple geometries instead of MULTI geometries.</td>
<tr>
<td>-W</td>
<td>&lt;encoding&gt; Specify the character encoding of Shape&#8217;s attribute column. (default : &#8220;WINDOWS-1252&#8243;)</td>
</tr>
</table>
<p></small></p>
<h3>Multipolygons</h3>
<p>Previously I have also used the <em>-S</em> switch with shp2pgsql, but for this KMZ file I got the following message.</p>
<pre>We have a Multipolygon with 40 parts, can't use -S switch!</pre>
<p><small></p>
<table>
<tr>
<td>-S</td>
<td>Generate simple geometries instead of MULTI geometries.</td>
<tr>
</table>
<p></small></p>
<h2>The SQL</h2>
<p>Let&#8217;s take a look at the SQL generated&#8230;</p>
<p><small>
<pre>SET CLIENT_ENCODING TO UTF8;
SET STANDARD_CONFORMING_STRINGS TO ON;
BEGIN;
CREATE TABLE "landslides" (gid serial PRIMARY KEY,
"name" varchar(80),
"descriptio" varchar(80),
"timestamp" date,
"begin" date,
"end" date,
"altitudemo" varchar(80),
"tessellate" numeric(10,0),
"extrude" numeric(10,0),
"visibility" numeric(10,0));
SELECT AddGeometryColumn('','landslides','the_geom','4326','MULTIPOLYGON',4);

INSERT INTO "landslides" ("name","descriptio","timestamp","begin","end","altitudemo",
"tessellate","extrude","visibility",the_geom) VALUES ('Mostly Landslide','Mostly Landslide',
NULL,NULL,NULL,NULL,'1','0','-1',
'01060000E0E61000002800000001030000E0E610000001000000060000009B559FABAD985EC0000000000060434000000
0000000F03F0000000000000000C0EC9E3C2C985EC00000000000604340000000000000F03F0000000000000000711B0DE
02D985EC032207BBDFB5F4340000000000000F03F0000000000000000386744696F985EC032207BBDFB5F4340000000000
000F03F000000000000000038F8C264AA985EC032207BBDFB5F4340000000000000F03F00000000000000009B559FABAD9
85EC00000000000604340000000000000F03F000000000000000001030000E0E61000000100000005000000613255302A9
95EC00000000000604340000000000000F03F00000000000000004CA60A4625995EC00000000000604340000000000000
F03F0000000000000000FED478E926995EC0DC291DACFF5F4340000000000000F03F0000000000000000B003E78C28995E
C00000000000604340000000000000F03F0000000000000000613255302A995EC00000000000604340000000000000F03F
0000000... (truncated)

INSERT INTO "landslides" ("name","descriptio","timestamp","begin","end","altitudemo",
"tessellate","extrude","visibility",the_geom) VALUES ('Few Landslides','Few Landslides',
NULL,NULL,NULL,NULL,'1','0','-1',
'01060000E0E61000001B00000001030000E0E610000004000000490600000000000000985EC0A83AE466B85D434000000
0000000F03F0000000000000000C7BAB88D06985EC068B3EA73B55D4340000000000000F03F000000000000000040A4DF
BE0E985EC0282CF180B25D4340000000000000F03F0000000000000000075F984C15985EC02F51BD35B05D434000000000
0000F03F00000000000000006ABC749318985EC076FD82DDB05D4340000000000000F03F00000000000000001CEBE2361
A985EC004560E2DB25D4340000000000000F03F0000000000000000CE1951DA1B985EC0D95A5F24B45D43400000000000
00F03F000000000000000095D4096822985EC0761A69A9BC5D4340000000000000F03F00000000000000004703780B249
85EC02849D74CBE5D4340000000000000F03F00000000000000005C8FC2F528985EC092CB7F48BF5D4340000000000000F
03F0000000000000000C0EC9E3C2C985EC0B6A1629CBF5D4340000000000000F03F0000000000000000234A7B832F985EC
092CB7F48BF5D4... (truncated)
</pre>
<p></small></p>
<p>The INSERT commands are pretty long, so I&#8217;ve truncated them here, but you can get the general idea.</p>
<h2>Loading SQL Into PostGIS</h2>
<p>We can now load the SQL we generated into our database. This is an easy step.</p>
<pre>psql -d $DB_NAME $DB_USER &lt; landslides.sql</pre>
<p>You see something like this, if all goes well.</p>
<pre>SET
SET
BEGIN
NOTICE:  CREATE TABLE will create implicit sequence "landslides_gid_seq" for serial column "landslides.gid"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "landslides_pkey" for table "landslides"
CREATE TABLE
                       addgeometrycolumn
----------------------------------------------------------------
 public.landslides.the_geom SRID:4326 TYPE:MULTIPOLYGON DIMS:4
(1 row)

INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
CREATE INDEX
COMMIT</pre>
<h2>Running SQL Queries Against Our PostGIS Database</h2>
<pre>
DB_NAME="landslide_db"
DB_USER="landslide_user"

psql -d $DB_NAME $DB_USER</pre>
<p>Our landslide database has four definitions of landslides, each mapping to a complex set of polgons (table column &#8220;the_geom&#8221; is TYPE:MULTIPOLYGON). Here are their names.</p>
<pre>landslide_db=> SELECT name FROM landslides;
       name
------------------
 Mostly Landslide
 Few Landslides
 Flat Land
 Not Mapped
(4 rows)</pre>
<p>Let&#8217;s look for landslides at latitude and longtitude position -122.3800, 38.7499. Here we find a bad location (meaning you would not build your house there) since this is in the bounds of &#8220;Mostly Landslide&#8221;.</p>
<pre>landslide_db=> SELECT name FROM landslides WHERE ST_Contains(the_geom,
ST_GeomFromWKB(ST_AsEWKB('POINT(<strong>-122.3800 38.7499</strong>)'::geometry), 4326));
       name
------------------
 <strong>Mostly Landslide</strong>
(1 row)
</pre>
<p>Let&#8217;s find somewhere with less landslides. Maybe -122.3752, 38.7321?</p>
<pre>landslide_db=> SELECT name FROM landslides WHERE ST_Contains(the_geom,
ST_GeomFromWKB(ST_AsEWKB('POINT(<strong>-122.3752 38.73215</strong>)'::geometry), 4326));
      name
----------------
 <strong>Few Landslides</strong>
(1 row)</pre>
<p>That is pretty good, but flat land would be better.</p>
<pre>landslide_db=> SELECT name FROM landslides WHERE ST_Contains(the_geom,
ST_GeomFromWKB(ST_AsEWKB('POINT(<strong>-122.4015 38.74941</strong>)'::geometry), 4326));
   name
-----------
 <strong>Flat Land</strong>
(1 row)</pre>
<p>Bingo! We&#8217;ve found some flat land that is landslide free. This seems like a safe place to conclude this blog post.</p>
<h2>Conclusion</h2>
<p>In this blog post I went through the steps needed to convert and load a KML 2.2 file into a PostGIS enabled PostgreSQL database. We installed PostGIS and all the tools needed to convert our KML file into an ESRI Shapefile and then into SQL statements that could be ran in PostgreSQL. We can now run SQL queries against our database which will return the landslide status for any given longitude and latitude within the focus area.</p>
<h2>Please Comment</h2>
<p>If you found this blog post useful then please leave a comment below.</p>
<h2>Related Books</h2>
<p><OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab" id="Player_a8377b86-aeb0-4c44-b1a4-cc2044d957a2"  WIDTH="600px" HEIGHT="200px"> <PARAM NAME="movie" VALUE="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&#038;MarketPlace=US&#038;ID=V20070822%2FUS%2Fgetafil-20%2F8010%2Fa8377b86-aeb0-4c44-b1a4-cc2044d957a2&#038;Operation=GetDisplayTemplate"><PARAM NAME="quality" VALUE="high"><PARAM NAME="bgcolor" VALUE="#FFFFFF"><PARAM NAME="allowscriptaccess" VALUE="always"><embed src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&#038;MarketPlace=US&#038;ID=V20070822%2FUS%2Fgetafil-20%2F8010%2Fa8377b86-aeb0-4c44-b1a4-cc2044d957a2&#038;Operation=GetDisplayTemplate" id="Player_a8377b86-aeb0-4c44-b1a4-cc2044d957a2" quality="high" bgcolor="#ffffff" name="Player_a8377b86-aeb0-4c44-b1a4-cc2044d957a2" allowscriptaccess="always"  type="application/x-shockwave-flash" align="middle" height="200px" width="600px"></embed></OBJECT> <NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&#038;MarketPlace=US&#038;ID=V20070822%2FUS%2Fgetafil-20%2F8010%2Fa8377b86-aeb0-4c44-b1a4-cc2044d957a2&#038;Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT></p>
                  </div><!-- .entry-content -->

        <p class="entry-meta"><span class="category">Posted in <a href="/category/geospatial" rel="tag">Geospatial</a>, <a href="/category/postgis" rel="tag">PostGIS</a>, <a href="/category/software-development" rel="tag">Software Development</a></span> <span class="post_tag">| Tagged <a href="/tag/esri-shapefile" rel="tag">esri shapefile</a>, <a href="/tag/gdal" rel="tag">gdal</a>, <a href="/tag/geo" rel="tag">geo</a>, <a href="/tag/geographic" rel="tag">geographic</a>, <a href="/tag/geospatial-2" rel="tag">geospatial</a>, <a href="/tag/gis" rel="tag">gis</a>, <a href="/tag/homebrew" rel="tag">homebrew</a>, <a href="/tag/kml" rel="tag">kml</a>, <a href="/tag/kmz" rel="tag">kmz</a>, <a href="/tag/landslides" rel="tag">landslides</a>, <a href="/tag/latitude" rel="tag">latitude</a>, <a href="/tag/libkml" rel="tag">libkml</a>, <a href="/tag/longitude" rel="tag">longitude</a>, <a href="/tag/macosx" rel="tag">macosx</a>, <a href="/tag/ogr2ogr" rel="tag">ogr2ogr</a>, <a href="/tag/postgis-2" rel="tag">postgis</a>, <a href="/tag/postgresql" rel="tag">postgresql</a>, <a href="/tag/shapefile" rel="tag">shapefile</a>, <a href="/tag/shp" rel="tag">shp</a>, <a href="/tag/sql" rel="tag">sql</a></span> </p>
      </div><!-- .hentry -->

    <div id="utility-after-singular" class="sidebar utility">

      <div id="text-16" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-after-singular .utility -->

    <div class="navigation-links">
      <a href="/embed-base64-encoded-images-inline-in-html" rel="prev"><span class="previous">&laquo; Previous</span></a>      <a href="/the-apache-projects-the-justice-league-of-scalability" rel="next"><span class="next">Next &raquo;</span></a>    </div><!-- .navigation-links -->

  </div><!-- .content .hfeed -->

  <div id="primary" class="sidebar aside">

        <div id="popularity-lists-1" class="widget widget_popularity_lists widget-widget_popularity_lists"><div class="widget-inside">      <h3 class="widget-title">Top Posts</h3>      <ul>
      <li><a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew - Intro To The Mac OS X Package Installer</a></li><li><a href="/quoras-technology-examined">Quora's Technology Examined</a></li><li><a href="/gitolite-installation-step-by-step">Gitolite Installation Step-By-Step</a></li><li><a href="/how-to-get-experience-working-with-large-datasets">How To Get Experience Working With Large Datasets</a></li><li><a href="/install-gitolite-to-manage-your-git-repositories">Install Gitolite To Manage Your Git Repositories</a></li><li><a href="/embed-base64-encoded-images-inline-in-html">Embed Base64-Encoded Images Inline In HTML</a></li><li><a href="/map-reduce-with-ruby-using-hadoop">Map-Reduce With Ruby Using Hadoop</a></li><li><a href="/highchart-vs-flot-js-comparing-javascript-graphing-engines">Highchart Vs Flot.js - Comparing JavaScript Graphing Engines </a></li>      </ul>
    </div></div><div id="hybrid-tags-2" class="widget tags widget-tags"><div class="widget-inside"><h3 class="widget-title">Tags</h3><p class="post_tag-cloud term-cloud"><a href='/tag/amazon-ec2' class='tag-link-211' title='6 topics' style='font-size: 15.194444444444pt;'>amazon ec2</a> <a href='/tag/android' class='tag-link-74' title='2 topics' style='font-size: 8pt;'>android</a> <a href='/tag/apple' class='tag-link-20' title='3 topics' style='font-size: 10.333333333333pt;'>apple</a> <a href='/tag/cassandra' class='tag-link-204' title='3 topics' style='font-size: 10.333333333333pt;'>cassandra</a> <a href='/tag/customers-2' class='tag-link-148' title='2 topics' style='font-size: 8pt;'>customers</a> <a href='/tag/data-processing-2' class='tag-link-107' title='5 topics' style='font-size: 13.833333333333pt;'>data processing</a> <a href='/tag/entrepreneur' class='tag-link-123' title='2 topics' style='font-size: 8pt;'>entrepreneur</a> <a href='/tag/entrepreneurship' class='tag-link-117' title='2 topics' style='font-size: 8pt;'>entrepreneurship</a> <a href='/tag/eventmachine-2' class='tag-link-422' title='3 topics' style='font-size: 10.333333333333pt;'>eventmachine</a> <a href='/tag/gem' class='tag-link-274' title='3 topics' style='font-size: 10.333333333333pt;'>gem</a> <a href='/tag/git' class='tag-link-177' title='3 topics' style='font-size: 10.333333333333pt;'>git</a> <a href='/tag/gitolite' class='tag-link-178' title='2 topics' style='font-size: 8pt;'>gitolite</a> <a href='/tag/google' class='tag-link-89' title='2 topics' style='font-size: 8pt;'>google</a> <a href='/tag/hadoop' class='tag-link-102' title='7 topics' style='font-size: 16.166666666667pt;'>hadoop</a> <a href='/tag/hbase' class='tag-link-264' title='4 topics' style='font-size: 12.277777777778pt;'>hbase</a> <a href='/tag/hdfs' class='tag-link-103' title='4 topics' style='font-size: 12.277777777778pt;'>hdfs</a> <a href='/tag/high-scalability' class='tag-link-114' title='3 topics' style='font-size: 10.333333333333pt;'>high scalability</a> <a href='/tag/homebrew' class='tag-link-216' title='4 topics' style='font-size: 12.277777777778pt;'>homebrew</a> <a href='/tag/install' class='tag-link-51' title='2 topics' style='font-size: 8pt;'>install</a> <a href='/tag/iphone' class='tag-link-65' title='2 topics' style='font-size: 8pt;'>iphone</a> <a href='/tag/java' class='tag-link-276' title='3 topics' style='font-size: 10.333333333333pt;'>java</a> <a href='/tag/location' class='tag-link-136' title='2 topics' style='font-size: 8pt;'>location</a> <a href='/tag/mac-osx' class='tag-link-59' title='2 topics' style='font-size: 8pt;'>mac osx</a> <a href='/tag/memcached' class='tag-link-306' title='4 topics' style='font-size: 12.277777777778pt;'>memcached</a> <a href='/tag/mongodb' class='tag-link-210' title='5 topics' style='font-size: 13.833333333333pt;'>mongodb</a> <a href='/tag/mysql' class='tag-link-293' title='3 topics' style='font-size: 10.333333333333pt;'>mysql</a> <a href='/tag/nginx' class='tag-link-326' title='4 topics' style='font-size: 12.277777777778pt;'>nginx</a> <a href='/tag/nosql' class='tag-link-205' title='6 topics' style='font-size: 15.194444444444pt;'>nosql</a> <a href='/tag/perl' class='tag-link-377' title='3 topics' style='font-size: 10.333333333333pt;'>perl</a> <a href='/tag/phone' class='tag-link-72' title='3 topics' style='font-size: 10.333333333333pt;'>phone</a> <a href='/tag/postgresql' class='tag-link-221' title='3 topics' style='font-size: 10.333333333333pt;'>postgresql</a> <a href='/tag/python' class='tag-link-355' title='5 topics' style='font-size: 13.833333333333pt;'>python</a> <a href='/tag/rails' class='tag-link-172' title='2 topics' style='font-size: 8pt;'>rails</a> <a href='/tag/redis' class='tag-link-301' title='3 topics' style='font-size: 10.333333333333pt;'>redis</a> <a href='/tag/ruby' class='tag-link-166' title='15 topics' style='font-size: 22pt;'>ruby</a> <a href='/tag/ruby-on-rails-2' class='tag-link-157' title='6 topics' style='font-size: 15.194444444444pt;'>ruby on rails</a> <a href='/tag/scala' class='tag-link-302' title='3 topics' style='font-size: 10.333333333333pt;'>scala</a> <a href='/tag/ssh-keygen' class='tag-link-180' title='2 topics' style='font-size: 8pt;'>ssh-keygen</a> <a href='/tag/startup' class='tag-link-119' title='3 topics' style='font-size: 10.333333333333pt;'>startup</a> <a href='/tag/tornado' class='tag-link-330' title='6 topics' style='font-size: 15.194444444444pt;'>tornado</a> <a href='/tag/twitter' class='tag-link-133' title='2 topics' style='font-size: 8pt;'>twitter</a> <a href='/tag/vancouver' class='tag-link-120' title='2 topics' style='font-size: 8pt;'>vancouver</a> <a href='/tag/web-development-2' class='tag-link-193' title='5 topics' style='font-size: 13.833333333333pt;'>web-development</a> <a href='/tag/whirr' class='tag-link-223' title='3 topics' style='font-size: 10.333333333333pt;'>whirr</a> <a href='/tag/wikipedia' class='tag-link-174' title='2 topics' style='font-size: 8pt;'>wikipedia</a></p></div></div>

  </div><!-- #primary .aside -->

  </div><!-- #container -->

  <div id="footer-container">

    <div id="footer">

      <small>Copyright &#169; 2016 <a class="site-link" href="/" title="Big Fast Blog" rel="home"><span>Big Fast Blog</span></a> | Vancouver, BC, Canada</small>
    </div><!-- #footer -->

  </div><!-- #footer-container -->

</div><!-- #body-container -->

</body>
</html>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15826070-1', 'auto');
  ga('send', 'pageview');

</script>
