{"componentChunkName":"component---src-templates-post-template-js","path":"/zero-copy-transfer-data-faster-in-ruby","result":{"data":{"markdownRemark":{"id":"b67547fa-aeb8-576b-bcd4-96a9061a6383","html":"<p><a href=\"https://www.flickr.com/photos/zitona/3749382854/\" title=\"McDreamy by Zitona on Flickr\"><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 270px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAYABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwT/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQID/9oADAMBAAIQAxAAAAGI6s865lQtrlrEZn//xAAaEAACAwEBAAAAAAAAAAAAAAABAgAREiEi/9oACAEBAAEFAlrHoxyEa1rNB0068U8IYT//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BgbP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABAx/9oACAECAQE/AcXkt//EAB0QAAICAQUAAAAAAAAAAAAAAAARAQIQEiExQVH/2gAIAQEABj8Cl9FXRVnw0mxwiZZAnj//xAAcEAEBAQEAAgMAAAAAAAAAAAABEQAhMWFBcaH/2gAIAQEAAT8hsovym6RMnWdjs0mCH65AML3nbmvjD7100U72nu//2gAMAwEAAgADAAAAEMvXv//EABcRAQEBAQAAAAAAAAAAAAAAABEAASH/2gAIAQMBAT8QwxbtgmTl/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAECAQE/EMsJARaN/8QAHhABAAMAAgIDAAAAAAAAAAAAAQARITFBUaFxkfD/2gAIAQEAAT8QFRhFIvzl/EV45FJS+Jegaalu7ETLW0OnWCezx0Xd/mI01AOCLfe76TffqMGxodyuoAREtaF9z//Z&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/cb4d94ba4c49fcfab92e76862994f066/8ac56/zero_copy_ruby.webp 240w,\n/static/cb4d94ba4c49fcfab92e76862994f066/3e767/zero_copy_ruby.webp 270w\" sizes=\"(max-width: 270px) 100vw, 270px\" type=\"image/webp\">\n        <source srcset=\"/static/cb4d94ba4c49fcfab92e76862994f066/09b79/zero_copy_ruby.jpg 240w,\n/static/cb4d94ba4c49fcfab92e76862994f066/6f81f/zero_copy_ruby.jpg 270w\" sizes=\"(max-width: 270px) 100vw, 270px\" type=\"image/jpeg\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/cb4d94ba4c49fcfab92e76862994f066/6f81f/zero_copy_ruby.jpg\" alt=\"Zero-Copy In Ruby Image\" title=\"Zero-Copy In Ruby Image\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span></a></p>\n<p>In this post I will explain the concept behind “zero-copy”, which is feature of the Linux allowing for faster transfer of data between pipes, file-descriptors and sockets. I will demonstrate how you can use this functionality in your Ruby projects using a code example. This functionality has been implemented in C, Java, Ruby, Perl and nameless other languages, but in this blog I will focus on the Ruby usage.</p>\n<h2 id=\"what-is-zero-copy\" style=\"position:relative;\"><a href=\"#what-is-zero-copy\" aria-label=\"what is zero copy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Is “Zero-Copy”?</h2>\n<p>The name “zero-copy” comes from the fact that the data is not copied from kernel-space to user-space as it usually would be. If you are serving a file, receiving a file, writing to a socket or reading from a socket or pipe and have no interest in programatically looking at the data then you can let the kernel do all the work. Your application runs in user-space and your application defines what you want to do with data as it comes in from various filehandles or sockets and out through other filehandles and sockets. Therefore, it is understandable that the kernel usually needs to pass the data your application, in user-space memory. Zero-copy cuts out the middle-man, your application, when your application is not interested in seeing the data. Roughly speaking, with zero-copy, you can give the kernel two file-descriptors and tell it kernel to “pass the data from one to the other and let me know when you are done”.</p>\n<h2 id=\"how-is-this-faster\" style=\"position:relative;\"><a href=\"#how-is-this-faster\" aria-label=\"how is this faster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Is This Faster?</h2>\n<h3 id=\"less-context-switching\" style=\"position:relative;\"><a href=\"#less-context-switching\" aria-label=\"less context switching permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Less Context-Switching</h3>\n<p>If you are reading this, I’ll assume you are a software developer or someone who can imagine what life would be like if you were a developer (the money, the women, the fame…). Have you ever tried writing code and being the person on support at the same? It is not easy. Every time you roll up your sleeves and get stuck into fixing that infinite for-loop, you get a call and your brain has start thinking about the problem of person on the other end of line. A day of this and you will get little done. It would be better to just be on support or just fixing infinite for-loops.</p>\n<p>When you serve up a static file to the web, the data is read from a file into your application and then your application writes it out to the socket. Even if you are using the lowest-level API in your chosen language for doing this, it is a two-step process and your application has made two requests to the kernel. “Read this”. “Write this”. Between these two steps the kernel is switching control back to your application and asking, “what next?”.</p>\n<p>With zero-copy you are saying to kernel, “read from <em>here</em> and write to <em>there</em>“. This is can be a single call to the kernel, which means less time passing control back to your application and saying, “what next?”.</p>\n<h3 id=\"less-copying\" style=\"position:relative;\"><a href=\"#less-copying\" aria-label=\"less copying permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Less Copying</h3>\n<p>The second reason that zero-copy is faster is because the kernel is not giving you the data. If it did it would have to copy the data from kernel-space to user-space, since kernel-space is for the kernel’s eyes only. Instead, the kernel knows what to do with that data. It transfers data from one filehandle to the other filehandle without bothering your application unless there is an error, it has completed, or the application has requested the transfer to be <a href=\"https://en.wikipedia.org/wiki/Asynchronous_I/O\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">non-blocking</a>.</p>\n<h3 id=\"splice\" style=\"position:relative;\"><a href=\"#splice\" aria-label=\"splice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>“Splice”</h3>\n<p>This system call that does the magic is called <a href=\"https://www.kernel.org/doc/man-pages/online/pages/man2/splice.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">splice</a>. You can read the <a href=\"https://www.kernel.org/doc/man-pages/online/pages/man2/splice.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Linux manual page here</a>.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ssize_t splice(int fd_in, loff_t *off_in, int fd_out,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               loff_t *off_out, size_t len, unsigned int flags);</span></span></code></pre>\n<p>The key to note here is that <em>one of the end-points must be a pipe</em>. If neither end-points are a pipe then you can create an intermediary pipe in kernel-space memory and tell the kernel to <em>write to</em> and <em>read from</em> that pipe. You can see <a href=\"/zero-copy-transfer-data-faster-in-ruby#ruby-example-copy-file-to-file\">an example of this below</a>, written in Ruby, where we copy data from one file to another without moving any of the data in user-space memory.</p>\n<h2 id=\"server-side-data-validation\" style=\"position:relative;\"><a href=\"#server-side-data-validation\" aria-label=\"server side data validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Server-Side Data Validation</h2>\n<p>The down-side to this is when you want to check the data before you send it out. It may make the server snappier, but if the data on disk is prone to corruption, then you would have to rely on the clients letting you know, since your application does not get chance to inspect the data.</p>\n<h2 id=\"other-factors\" style=\"position:relative;\"><a href=\"#other-factors\" aria-label=\"other factors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Factors</h2>\n<p>While you may take some of the burden off the CPU and there is less time spent copying memory, depending on your system and your usage you may not see much difference. Disk seek time and network latency often leave the CPU twiddling it’s thumbs. Memory copying is very fast. Therefore, you should weigh up the cost and benefits to this. The cost would be the possibly limiting your code to the Linux platform and an additional dependency of the extra code needed to do this (a gem in Ruby’s case).</p>\n<h2 id=\"performance\" style=\"position:relative;\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h2>\n<p>If you’re interested in getting deeper into this or would like to approach it from more of a Java angle, then I recommend checking out “<a href=\"https://www.ibm.com/developerworks/library/j-zerocopy/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Efficient data transfer through zero copy</a>” by <a href=\"https://www.ibm.com/developerworks/library/j-zerocopy/index.html#author1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sathish K. Palaniappan</a> and <a href=\"https://www.ibm.com/developerworks/library/j-zerocopy/index.html#author2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pramod B. Nagaraja</a>. It’s from here I take the following performance results.</p>\n<table>\n<tr>\n<th>File size</th>\n<th>Non zero-copy</th>\n<th>Zero-copy</th>\n<th>How much faster?</th>\n</tr>\n<tr>\n<td>7 Mb</td>\n<td>156 ms</td>\n<td>45ms</td>\n<td>346 % faster</td>\n</tr>\n<tr>\n<td>200 Mb</td>\n<td>2124 ms</td>\n<td>1150 ms</td>\n<td>184 % faster</td>\n</tr>\n<tr>\n<td>1 Gb</td>\n<td>18399 ms</td>\n<td>8537 ms</td>\n<td>215 % faster</td>\n</tr>\n</table>\n<p>It is hard to make a clear opinion on the exact speed increase, since the performance change is non-linear, but saying that you get a 2x performance would not be unreasonable.</p>\n<p>If you want to run your own tests to replicate this then <a href=\"https://www.ibm.com/developerworks/apps/download/index.jsp?contentid=333543&#x26;filename=j-zerocopy.zip&#x26;method=http&#x26;locale=worldwide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the Java source code</a> is available on their article.</p>\n<p>Some other recent benchmarks by Iñaki Baz Castillo, which were written in Ruby, can be found <a href=\"https://librelist.com/browser//ruby.io.splice/2010/12/22/some-benchmarks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. I use code from these benchmarks in <a href=\"/zero-copy-transfer-data-faster-in-ruby#ruby-example-copy-file-to-file\">the example below</a>.</p>\n<h2 id=\"ruby-implementation\" style=\"position:relative;\"><a href=\"#ruby-implementation\" aria-label=\"ruby implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ruby Implementation</h2>\n<p>In Ruby there is an implementation of zero-copy called <a href=\"https://bogomips.org/ruby_io_splice\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">io_splice</a>. This is not supported on Mac OS X, since zero-copy is Linux specific. You will get installation problems if you install this on anything less than Linux Kernel 2.6.17.</p>\n<h3 id=\"installing-the-gem\" style=\"position:relative;\"><a href=\"#installing-the-gem\" aria-label=\"installing the gem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installing The Gem</h3>\n<p>You can install the gem in the same way you install other gems.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem install io_splice</span></span></span></code></pre>\n<p>The usual gem install output…</p>\n<pre class=\"grvsc-container monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Building native extensions.  This could take a while...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Successfully installed io_splice-2.2.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1 gem installed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Installing ri documentation </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> io_splice-2.2.0...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Installing RDoc documentation </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> io_splice-2.2.0...</span></span></span></code></pre>\n<p><a id=\"ruby-example-copy-file-to-file\"></a></p>\n<h3 id=\"ruby-example--copy-file-to-file\" style=\"position:relative;\"><a href=\"#ruby-example--copy-file-to-file\" aria-label=\"ruby example  copy file to file permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ruby Example – Copy File To File</h3>\n<p>In this example I will copy a file from one location to another.</p>\n<p>Let’s create an input file first, called <em>input\\</em>file.txt_</p>\n<pre class=\"grvsc-container monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ruby -e </span><span class=\"mtk6\">&#39;1_000_000.times { puts rand.to_s }&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> input_file.txt</span></span></span></code></pre>\n<p>Now, I’m going to write a short Ruby script called <em>test\\</em>filecopy.rb_. I have taken the meat of this script from <a href=\"https://dev.sipdoc.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Iñaki Baz Castillo</a>‘s benchmark code. </p>\n<pre class=\"grvsc-container monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/ruby</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;io/splice&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">SRC_FILE </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;input_file.txt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">DST_FILE </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;output_file.txt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">source </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk9\">open</span><span class=\"mtk1\">(SRC_FILE, </span><span class=\"mtk6\">&#39;rb&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dest </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk9\">open</span><span class=\"mtk1\">(DST_FILE, </span><span class=\"mtk6\">&#39;wb&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">source_fd </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> source.fileno</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dest_fd </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> dest.fileno</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># We use a pipe as a ring buffer in kernel space.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># pipes may store up to IO::Splice::PIPE_CAPA bytes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pipe </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">IO</span><span class=\"mtk1\">.pipe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rfd, wfd </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pipe.map { |io| io.fileno }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">while</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nread </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># first pull as many bytes as possible into the pipe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IO</span><span class=\"mtk1\">.splice(source_fd, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, wfd, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">IO</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Splice</span><span class=\"mtk1\">::PIPE_CAPA, </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> EOFError</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># The end of the file has been reached</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># now move the contents of the pipe buffer into the destination file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># the copied data never enters userspace</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nwritten </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">IO</span><span class=\"mtk1\">.splice(rfd, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, dest_fd, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, nread, </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Sure enough, it copied the file. Although, if you were paying attention, you will realize that even though we did not read the data into user-space memory, we still copied it into an intermediary pipe in kernel-space memory. We also had an extra context switch back to our code between the reading from one file and writing to the other. This is because we cannot use zero-copy to transfer directly from one file-descriptor to another file-descriptor without one of the end-points being a pipe. To get around this we created the in-kernel-memory pipe as an intermediary.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Zero-copy is way to increase performance when transferring static data between two end-points on your system. A good use-case for this is serving files to the web. Even though the disk is still a major bottle-neck, benchmarks do show it to be faster. If validating the data going out of your system is important to you then zero-copy may not be the solution you are looking for, as the data never enters user-space, so there is no chance to inspect it.</p>\n<h2 id=\"resources\" style=\"position:relative;\"><a href=\"#resources\" aria-label=\"resources permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resources</h2>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Zero-copy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Zero-Copy On Wikipedia</a></li>\n<li><a href=\"https://www.linuxjournal.com/article/6345\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Zero Copy I: User-Mode Perspective</a></li>\n<li><a href=\"https://bogomips.org/ruby_io_splice/IO.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">“Ruby IO Splice” Documentation</a></li>\n<li><a href=\"https://www.kernel.org/doc/man-pages/online/pages/man2/splice.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Splice man-page</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/library/j-zerocopy/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Efficient data transfer through zero copy</a></li>\n<li><a href=\"https://bogomips.org/ruby_io_splice/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ruby IO Splice Homepage</a></li>\n<li><a href=\"https://stackoverflow.com/questions/3137594/how-to-create-pi-sequentially-in-ruby\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to create PI sequentially in Ruby</a></li>\n</ul>\n<h2 id=\"comments\" style=\"position:relative;\"><a href=\"#comments\" aria-label=\"comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h2>\n<div id=\"comments\">\n  <ol class=\"comment-list\">\n    <li id=\"comment-807\" class=\"comment even thread-even depth-1 comment reader\">\n      <img alt=\"iq9\" src=\"https://0.gravatar.com/avatar/092ff97a9cf1189c671baecc59f8bf65?s=80&amp;d=https%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG\" class=\"avatar avatar-80 photo\" height=\"80\" width=\"80\">\n      <div class=\"comment-meta comment-meta-data\">\n        <div class=\"comment-author vcard\">\n          <cite class=\"fn\" title=\"https://russbrooks.com\">iq9</cite>\n        </div>\n        <!-- .comment-author .vcard -->\n        <abbr class=\"comment-date\" title=\"Thursday, January 20th, 2011, 8:08 am\">January 20, 2011</abbr> at <abbr class=\"comment-time\" title=\"Thursday, January 20th, 2011, 8:08 am\">8:08 am</abbr>\n      </div>\n      <div class=\"comment-text\">\n        <p>It would be interesting to see straight calls to `cp` in their benchmarks. https://librelist.com/browser//ruby.io.splice/2010/12/22/some-benchmarks/</p>\n      </div>\n      <!-- .comment-text -->\n    </li>\n    <!-- .comment -->\n    <li id=\"comment-813\" class=\"comment odd alt thread-odd thread-alt depth-1 comment reader\">\n      <img alt=\"Carl Youngblood\" src=\"https://0.gravatar.com/avatar/eca15b2b601e7e577d38bd5210a753ac?s=80&amp;d=https%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG\" class=\"avatar avatar-80 photo\" height=\"80\" width=\"80\">\n      <div class=\"comment-meta comment-meta-data\">\n        <div class=\"comment-author vcard\">\n          <cite class=\"fn\">Carl Youngblood</cite>\n        </div>\n        <!-- .comment-author .vcard -->\n        <abbr class=\"comment-date\" title=\"Thursday, January 20th, 2011, 11:51 pm\">January 20, 2011</abbr> at <abbr class=\"comment-time\" title=\"Thursday, January 20th, 2011, 11:51 pm\">11:51 pm</abbr>\n      </div>\n      <div class=\"comment-text\">\n        <p>I wonder if someone more familiar with OSX is aware of another construct in BSD land for doing the same thing. Any takers?</p>\n      </div>\n      <!-- .comment-text -->\n    </li>\n    <!-- .comment -->\n  </ol>\n  <!-- .comment-list -->\n</div>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/zero-copy-transfer-data-faster-in-ruby","tagSlugs":["/tag/file-server/","/tag/gem/","/tag/io/","/tag/io-splice/","/tag/java/","/tag/linux/","/tag/ruby/","/tag/splice/","/tag/zero-copy/"]},"frontmatter":{"date":"2011-01-14T13:27:00-08:00","description":"In this post I will explain the concept behind zero-copy, which is feature of the Linux allowing for faster transfer of data between pipes, file-descriptors and sockets. I will demonstrate how you can use this functionality in your Ruby projects using a code example. This functionality has been implemented in C, Java, Ruby, Perl and nameless other languages, but in this blog I will focus on the Ruby usage.","tags":["file-server","gem","io","io_splice","java","linux","ruby","splice","zero-copy"],"title":"Zero-Copy. Transfer Data Faster In Ruby","socialImage":{"publicURL":{"publicURL":"/static/f8017db050cd6fb9c44f5e8f8fb1731b/zero_copy_ruby_sq.jpg"}}}}},"pageContext":{"slug":"/zero-copy-transfer-data-faster-in-ruby"}},"staticQueryHashes":["251939775","3942705351","401334301"]}