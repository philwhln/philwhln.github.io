<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="https://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xml:lang="en-US">
<head profile="https://gmpg.org/xfn/11">
<title>Rollout, Degrade, Metrics and Capacity | Big Fast Blog</title>

<link rel="stylesheet" href="/css/style.css" type="text/css" media="screen" />
<link rel="author" href="https://plus.google.com/101358683928607234715/posts"/>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Rollout, Degrade, Metrics and Capacity Comments Feed" href="/rollout-degrade-metrics-and-capacity/feed" />

<meta name="description" content="Last week I attended a presentation by James Golick, CTO of fetlife.com. Intriguingly advertised as Scaling a Website to 300 Million Page Views Per Month with" />
<meta name="keywords" content="a-b-testing,averages,capacity planning,degrade,fetlife,ganglia,metrics,monitoring,percentiles,redis,rollout,ruby,scala" />
<link rel="canonical" href="/rollout-degrade-metrics-and-capacity" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-15826070-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-15826070-1');
</script>
</head>

<body>

<div id="body-container">
  <div id="container">

  <div id="content" class="hfeed content">

    <div id="utility-before-content" class="sidebar utility">

      <div id="text-13" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-before-content .utility -->

      <div id="post-1418" class="hentry post publish post-1 odd author-admin category-system-administration category-web-development post_tag-a-b-testing post_tag-averages post_tag-capacity-planning post_tag-degrade post_tag-fetlife post_tag-ganglia post_tag-metrics post_tag-monitoring post_tag-percentiles post_tag-redis post_tag-rollout post_tag-ruby post_tag-scala">

        <h1 class="post-title entry-title"><a href="/rollout-degrade-metrics-and-capacity" title="Rollout, Degrade, Metrics and Capacity" rel="bookmark">Rollout, Degrade, Metrics and Capacity</a></h1><p class="byline"><span class="byline-prep byline-prep-author">By</span> <span class="author vcard"><span class="fn">Phil Whelan</span></span> <span class="byline-prep byline-prep-published">on</span> <abbr class="published" title="Tuesday, December 13th, 2011, 4:16 pm">December 13, 2011</abbr> </p>
        <div class="entry-content">
          <div style="height: 280px"><a href="https://www.flickr.com/photos/yvoictra/3498203833/"><img src="https://commondatastorage.googleapis.com/philwhln/blog/images/rollout_degrade_metrics_and_capacity/rollout-degrade-metrics-and-capacity.jpg" align="left" width="320" height="251"></a> Last week I attended a presentation by <a href="https://jamesgolick.com/">James Golick</a>, CTO of <a href="https://www.fetlife.com">fetlife.com</a>. Intriguingly advertised as <a href="https://www.meetup.com/vancouver-scala/events/38342382/">&#8220;Scaling a Website to 300 Million Page Views Per Month with Scala&#8221;</a> I thought it was worth a break from building <a href="https://www.cooq.com/">cooq.com</a> to attend. Fetlife have been heavy users of Ruby, but are transitioning to Scala and having been using Scala code in production for 2 years. Several of the tools mentioned below are built in Ruby, but they plan to migrate them to Scala over time.</div>
<h2>Rollout</h2>
<p><a href="https://github.com/jamesgolick/rollout">Rollout</a> is a Ruby package used to deploy new features in a controlled manner. It uses a central configuration hosted within <a href="https://redis.io/">Redis</a> to manage instantaneous deployment on a per-user basis. For instance, Fetlife uses it specify that 10% of their user-base should be able to see feature X when they view the website. This is done very basically by modulo of user id. At 10% any user that has a user id ending in &#8220;1&#8243; will see the new feature. The same subset of users will always see any new features first.</p>
<p>Updates to Rollout&#8217;s configuration will occur immediately due to the inline code fetlife uses within it&#8217;s web application.</p>
<pre>
if $rollout.active?(:chat, User.first)
    # implement chat feature
end
</pre>
<p>The above code checks with Rollout whether the &#8220;chat&#8221; feature is active for this user. If it is then we go on to run through the code that implements this feature. This <em>$rollout.active</em> statement results in a call to Redis which responses with <em>true</em> or <em>false</em>.</p>
<p>For me this seems like a pretty elegant solution. The downside is that a site with a lot of users and a lot of features is going to being hitting Redis pretty hard (requests to Redis = user requests x features). Luckily, Redis runs in memory, so it is very fast. It can also be scaled horizontally across a cluster to increase the throughput of requests.</p>
<h2>Degrade</h2>
<p><a href="https://github.com/jamesgolick/degrade">Degrade</a> is another open source Ruby package written by Fetlife. It focuses on isolating failures by monitoring the error rates from a given feature and applying Rollout rules as failure thresholds are reached.</p>
<p>It is not necessary to use Rollout to take action when a threshold is reached. The trigger is simply a programmer-defined Ruby function that should be called. Obviously, Degrade and Rollout go hand-in-hand, so if you are using Rollout, then it makes sense to use Rollout to degrade the use of the failing feature.</p>
<p>Like Rollout, Degrade uses <a href="https://redis.io/">Redis</a> to manage the failure statistics.</p>
<h2>Metrics</h2>
<h3>Ganglia</h3>
<p>In his talk, James spoke highly of <a href="https://ganglia.sourceforge.net/">Ganglia</a> for system monitoring metrics. It&#8217;s very scalable and can be used to monitoring large clusters, such as clusters running sizeable <a href="https://www.cloudera.com/blog/2009/03/hadoop-metrics/">Hadoop</a> deployments.</p>
<p>Any metrics can be pushed to Ganglia, so it can be <a href="https://www.igvita.com/2010/01/28/cluster-monitoring-with-ganglia-ruby/">integrated with your code</a> easily. Functions can be wrapped in timers and captured durations can be pushed to the Ganglia daemon. Ganglia creates a new RRD file for each new metric that is pushed to it.</p>
<h3>Don&#8217;t Be Average</h3>
<blockquote><p><em>&#8220;By the time an anomaly is reflected in the average (mean), it&#8217;s already too late&#8221;</em><br /><small> &#8211; James Golick, BitLove</small>
</p></blockquote>
<p>James highlighted the importance of looking a percentiles over averages. Looking at edges cases is much more useful. If you see 1% of requests taking 10 times longer than other requests, then there&#8217;s an obvious problem that can be looked into and fixed before it becomes a real issue. If you wait until you see the average rise, it may be too late. We all know the knock on effect of what happens when things start backing up. More memory is used. Less memory is available to resolve the issue and the situation can spiral out of control quickly.</p>
<h3>Take A Broad View</h3>
<p>Looking at single servers statistics in Ganglia, of an alternative metrics system, can hide anomalies. James pointed out that if 1 server out of 30 was taking 20 milliseconds longer to do something, by itself would not look unhealthy. But in a line-up with the other 29 servers, it would stand out and would warrant further investigation. This may be another early sign of something bad on the horizon.</p>
<p>There are too many statistics for each server to possibly notice anomalies if you view them one server at a time.</p>
<h2>Capacity Planning</h2>
<p>Capacity Planning is something that James&#8217; team at Fetlife focus on on a regular basis. They are not highly scientific about it, but they understand that it is highly important.</p>
<p>James suggested looking at the book <a href="https://shop.oreilly.com/product/9780596518585.do">The Art Of Capacity Planning</a>, but the suggested that it might put you to sleep due to it heavy focus on <em>best-fit-curves</em>. Rather than curves, Fetlife use a simple straight line to project future hardware requirements and continuously readjust this line over time. He suggested that unless you are Facebook high-science in this area is not important. For Facebook, being off the curve can cost millions of dollars in redundant hardware or potential downtime, so the risks are higher. At the smaller scale this cost of complexity outweighs the cost of having 10% too much hardware.</p>
<h3>Understand Your Spikes</h3>
<p>Capacity planning is not just about projecting your current usage. Websites have spikes. During certain sports events Twitter and Facebook see large spikes in traffic. They understand their spikes, know how big their potential are and plan accordingly. James points out that for most sites spikes are very small and even with the worst spiky offenders, after a couple of spikes you have a pretty good idea of what to expect.</p>
                  </div><!-- .entry-content -->

        <p class="entry-meta"><span class="category">Posted in <a href="/category/system-administration" rel="tag">System Administration</a>, <a href="/category/web-development" rel="tag">Web Development</a></span> <span class="post_tag">| Tagged <a href="/tag/a-b-testing" rel="tag">a-b-testing</a>, <a href="/tag/averages" rel="tag">averages</a>, <a href="/tag/capacity-planning" rel="tag">capacity planning</a>, <a href="/tag/degrade" rel="tag">degrade</a>, <a href="/tag/fetlife" rel="tag">fetlife</a>, <a href="/tag/ganglia" rel="tag">ganglia</a>, <a href="/tag/metrics" rel="tag">metrics</a>, <a href="/tag/monitoring" rel="tag">monitoring</a>, <a href="/tag/percentiles" rel="tag">percentiles</a>, <a href="/tag/redis" rel="tag">redis</a>, <a href="/tag/rollout" rel="tag">rollout</a>, <a href="/tag/ruby" rel="tag">ruby</a>, <a href="/tag/scala" rel="tag">scala</a></span> | <a class="comments-link" href="/rollout-degrade-metrics-and-capacity#comments" title="Comment on Rollout, Degrade, Metrics and Capacity">1 Response</a></p>
      </div><!-- .hentry -->

<div id="comments-template">

    <div id="comments">

      <h3 id="comments-number" class="comments-header">One response to &#8220;Rollout, Degrade, Metrics and Capacity&#8221;</h3>

      <ol class="comment-list">

  <li id="comment-6614" class="pingback even thread-even depth-1 pingback reader">

    <a href="https://looselyconnected.wordpress.com/2011/12/16/link-rollout-degrade-metrics-and-capacity/" rel="external nofollow" title="Link: Rollout Degrade Metrics and Capacity | Loosely Connected"><img alt='Link: Rollout Degrade Metrics and Capacity | Loosely Connected' src='https://0.gravatar.com/avatar/?d=https://www.bigfastblog.com/css/library/images/pingback.png&amp;s=80' class='avatar avatar-80 photo avatar-default' height='80' width='80' /></a><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn" title="https://looselyconnected.wordpress.com/2011/12/16/link-rollout-degrade-metrics-and-capacity/"><a href="https://looselyconnected.wordpress.com/2011/12/16/link-rollout-degrade-metrics-and-capacity/" title="Link: Rollout Degrade Metrics and Capacity | Loosely Connected" class="url" rel="external nofollow">Link: Rollout Degrade Metrics and Capacity | Loosely Connected</a></cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Friday, December 16th, 2011, 8:13 am">December 16, 2011</abbr> at <abbr class="comment-time" title="Friday, December 16th, 2011, 8:13 am">8:13 am</abbr></span>  </div>
    <div class="comment-text">

      <blockquote><p>This is a pretty fascinating article. While very high level, it talks about things I’ve been interested in (on a much smaller scale) for a while.</p>
<p>I’ve hand-coded some solutions that do these sorts of things, but not to this scale or completeness. The article surprised me with the nature of some of the technologies they were using; for example, I’d always thought of Ganglia as a monitoring solution, not for metrics gathering.</p></blockquote>
    </div><!-- .comment-text -->

  </li><!-- .comment -->      </ol><!-- .comment-list -->
    </div><!-- #comments -->

</div><!-- #comments-template -->

    <div class="navigation-links">
      <a href="/summifys-technology-examined" rel="prev"><span class="previous">&laquo; Previous</span></a>      <a href="/geohash-intro" rel="next"><span class="next">Next &raquo;</span></a>    </div><!-- .navigation-links -->

  </div><!-- .content .hfeed -->

  <div id="primary" class="sidebar aside">

        <div id="popularity-lists-1" class="widget widget_popularity_lists widget-widget_popularity_lists"><div class="widget-inside">      <h3 class="widget-title">Top Posts</h3>      <ul>
      <li><a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew - Intro To The Mac OS X Package Installer</a></li><li><a href="/quoras-technology-examined">Quora's Technology Examined</a></li><li><a href="/gitolite-installation-step-by-step">Gitolite Installation Step-By-Step</a></li><li><a href="/how-to-get-experience-working-with-large-datasets">How To Get Experience Working With Large Datasets</a></li><li><a href="/install-gitolite-to-manage-your-git-repositories">Install Gitolite To Manage Your Git Repositories</a></li><li><a href="/embed-base64-encoded-images-inline-in-html">Embed Base64-Encoded Images Inline In HTML</a></li><li><a href="/map-reduce-with-ruby-using-hadoop">Map-Reduce With Ruby Using Hadoop</a></li><li><a href="/highchart-vs-flot-js-comparing-javascript-graphing-engines">Highchart Vs Flot.js - Comparing JavaScript Graphing Engines </a></li>      </ul>
    </div></div><div id="hybrid-tags-2" class="widget tags widget-tags"><div class="widget-inside"><h3 class="widget-title">Tags</h3><p class="post_tag-cloud term-cloud"><a href='/tag/amazon-ec2' class='tag-link-211' title='6 topics' style='font-size: 15.194444444444pt;'>amazon ec2</a> <a href='/tag/android' class='tag-link-74' title='2 topics' style='font-size: 8pt;'>android</a> <a href='/tag/apple' class='tag-link-20' title='3 topics' style='font-size: 10.333333333333pt;'>apple</a> <a href='/tag/cassandra' class='tag-link-204' title='3 topics' style='font-size: 10.333333333333pt;'>cassandra</a> <a href='/tag/customers-2' class='tag-link-148' title='2 topics' style='font-size: 8pt;'>customers</a> <a href='/tag/data-processing-2' class='tag-link-107' title='5 topics' style='font-size: 13.833333333333pt;'>data processing</a> <a href='/tag/entrepreneur' class='tag-link-123' title='2 topics' style='font-size: 8pt;'>entrepreneur</a> <a href='/tag/entrepreneurship' class='tag-link-117' title='2 topics' style='font-size: 8pt;'>entrepreneurship</a> <a href='/tag/eventmachine-2' class='tag-link-422' title='3 topics' style='font-size: 10.333333333333pt;'>eventmachine</a> <a href='/tag/gem' class='tag-link-274' title='3 topics' style='font-size: 10.333333333333pt;'>gem</a> <a href='/tag/git' class='tag-link-177' title='3 topics' style='font-size: 10.333333333333pt;'>git</a> <a href='/tag/gitolite' class='tag-link-178' title='2 topics' style='font-size: 8pt;'>gitolite</a> <a href='/tag/google' class='tag-link-89' title='2 topics' style='font-size: 8pt;'>google</a> <a href='/tag/hadoop' class='tag-link-102' title='7 topics' style='font-size: 16.166666666667pt;'>hadoop</a> <a href='/tag/hbase' class='tag-link-264' title='4 topics' style='font-size: 12.277777777778pt;'>hbase</a> <a href='/tag/hdfs' class='tag-link-103' title='4 topics' style='font-size: 12.277777777778pt;'>hdfs</a> <a href='/tag/high-scalability' class='tag-link-114' title='3 topics' style='font-size: 10.333333333333pt;'>high scalability</a> <a href='/tag/homebrew' class='tag-link-216' title='4 topics' style='font-size: 12.277777777778pt;'>homebrew</a> <a href='/tag/install' class='tag-link-51' title='2 topics' style='font-size: 8pt;'>install</a> <a href='/tag/iphone' class='tag-link-65' title='2 topics' style='font-size: 8pt;'>iphone</a> <a href='/tag/java' class='tag-link-276' title='3 topics' style='font-size: 10.333333333333pt;'>java</a> <a href='/tag/location' class='tag-link-136' title='2 topics' style='font-size: 8pt;'>location</a> <a href='/tag/mac-osx' class='tag-link-59' title='2 topics' style='font-size: 8pt;'>mac osx</a> <a href='/tag/memcached' class='tag-link-306' title='4 topics' style='font-size: 12.277777777778pt;'>memcached</a> <a href='/tag/mongodb' class='tag-link-210' title='5 topics' style='font-size: 13.833333333333pt;'>mongodb</a> <a href='/tag/mysql' class='tag-link-293' title='3 topics' style='font-size: 10.333333333333pt;'>mysql</a> <a href='/tag/nginx' class='tag-link-326' title='4 topics' style='font-size: 12.277777777778pt;'>nginx</a> <a href='/tag/nosql' class='tag-link-205' title='6 topics' style='font-size: 15.194444444444pt;'>nosql</a> <a href='/tag/perl' class='tag-link-377' title='3 topics' style='font-size: 10.333333333333pt;'>perl</a> <a href='/tag/phone' class='tag-link-72' title='3 topics' style='font-size: 10.333333333333pt;'>phone</a> <a href='/tag/postgresql' class='tag-link-221' title='3 topics' style='font-size: 10.333333333333pt;'>postgresql</a> <a href='/tag/python' class='tag-link-355' title='5 topics' style='font-size: 13.833333333333pt;'>python</a> <a href='/tag/rails' class='tag-link-172' title='2 topics' style='font-size: 8pt;'>rails</a> <a href='/tag/redis' class='tag-link-301' title='3 topics' style='font-size: 10.333333333333pt;'>redis</a> <a href='/tag/ruby' class='tag-link-166' title='15 topics' style='font-size: 22pt;'>ruby</a> <a href='/tag/ruby-on-rails-2' class='tag-link-157' title='6 topics' style='font-size: 15.194444444444pt;'>ruby on rails</a> <a href='/tag/scala' class='tag-link-302' title='3 topics' style='font-size: 10.333333333333pt;'>scala</a> <a href='/tag/ssh-keygen' class='tag-link-180' title='2 topics' style='font-size: 8pt;'>ssh-keygen</a> <a href='/tag/startup' class='tag-link-119' title='3 topics' style='font-size: 10.333333333333pt;'>startup</a> <a href='/tag/tornado' class='tag-link-330' title='6 topics' style='font-size: 15.194444444444pt;'>tornado</a> <a href='/tag/twitter' class='tag-link-133' title='2 topics' style='font-size: 8pt;'>twitter</a> <a href='/tag/vancouver' class='tag-link-120' title='2 topics' style='font-size: 8pt;'>vancouver</a> <a href='/tag/web-development-2' class='tag-link-193' title='5 topics' style='font-size: 13.833333333333pt;'>web-development</a> <a href='/tag/whirr' class='tag-link-223' title='3 topics' style='font-size: 10.333333333333pt;'>whirr</a> <a href='/tag/wikipedia' class='tag-link-174' title='2 topics' style='font-size: 8pt;'>wikipedia</a></p></div></div>

  </div><!-- #primary .aside -->

  </div><!-- #container -->



</div><!-- #body-container -->

</body>
</html>
