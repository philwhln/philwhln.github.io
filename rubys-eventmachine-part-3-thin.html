<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="https://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xml:lang="en-US">
<head profile="https://gmpg.org/xfn/11">
<title>Ruby’s EventMachine – Part 3 : Thin | Big Fast Blog</title>

<link rel="stylesheet" href="/wp-content/themes/hybrid/style.css" type="text/css" media="screen" />
<link rel="author" href="https://plus.google.com/101358683928607234715/posts"/>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Big Fast Blog &raquo; Ruby’s EventMachine – Part 3 : Thin Comments Feed" href="/rubys-eventmachine-part-3-thin/feed" />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='/wp-content/plugins/sharebar/js/sharebar.js'></script>
<meta name="description" content="As mentioned in part 1 and part 2 of this series on Ruby's EventMachine, Thin is where most folks encounter EventMachine for the first time, even if they do not realize it. EventMachine is at the core of Thin and allows for the high concurrency that Thin provides to your Rails application. In this post I will look at Thin's usage of EventMachine." />
<meta name="keywords" content="event-based,event-loop,eventmachine,rack,ruby,ruby on rails,thin,web server,web-development" />
<link rel="canonical" href="/rubys-eventmachine-part-3-thin" />
  <link rel="stylesheet" href="/wp-content/plugins/sharebar/css/sharebar.css" type="text/css" media="screen" />
<script type="text/javascript">jQuery(document).ready(function($) { $('.sharebar').sharebar({horizontal:'true',swidth:'65',minwidth:1000,position:'left',leftOffset:20,rightOffset:10}); });</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15826070-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>

<div id="body-container">
  <div id="container">

  <div id="content" class="hfeed content">

    <div id="utility-before-content" class="sidebar utility">

      <div id="text-13" class="widget widget_text widget-widget_text"><div class="widget-inside">      <div class="textwidget"><a href="https://twitter.com/philwhln" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @philwhln</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
    </div></div>
    </div><!-- #utility-before-content .utility -->

      <div id="post-1788" class="hentry post publish post-1 odd author-admin category-eventmachine category-ruby-2 category-ruby-on-rails post_tag-event-based post_tag-event-loop post_tag-eventmachine-2 post_tag-rack post_tag-ruby post_tag-ruby-on-rails-2 post_tag-thin post_tag-web-server post_tag-web-development-2">

        <h1 class="post-title entry-title"><a href="/rubys-eventmachine-part-3-thin" title="Ruby’s EventMachine – Part 3 : Thin" rel="bookmark">Ruby’s EventMachine – Part 3 : Thin</a></h1><p class="byline"><span class="byline-prep byline-prep-author">By</span> <span class="author vcard"><span class="fn">Phil Whelan</span></span> <span class="byline-prep byline-prep-published">on</span> <abbr class="published" title="Tuesday, October 30th, 2012, 2:26 pm">October 30, 2012</abbr> </p>
        <div class="entry-content">
          <ul id="sharebar" style="background:#;border-color:#;">
<li><a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-via="philwhln">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script></li><li><iframe src="https://www.facebook.com/plugins/like.php?href=https://www.bigfastblog.com/rubys-eventmachine-part-3-thin&layout=box_count&show_faces=false&width=60&action=like&colorscheme=light&height=45" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:45px; height:60px;" allowTransparency="true"></iframe></li></ul><ul id="sharebarx">
<li><a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="philwhln">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script></li><li><iframe src="https://www.facebook.com/plugins/like.php?href=https://www.bigfastblog.com/rubys-eventmachine-part-3-thin&layout=button_count&show_faces=false&width=85&action=like&colorscheme=light&height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:85px; height:21px;" allowTransparency="true"></iframe></li></ul><p>As mentioned in <a href="/rubys-eventmachine-part-1-event-based-programming">part 1</a> and <a href="/ruby-eventmachine-part-2-asynchronous-not-equal-faster">part 2</a> of this <a href="/category/ruby-2/eventmachine">series on Ruby&#8217;s EventMachine</a>, Thin is where most folks encounter EventMachine for the first time, even if they do not realize it. EventMachine is at the core of Thin and allows for the high concurrency that Thin provides to your Rails application. In this post I will look at Thin&#8217;s usage of EventMachine.</p>
<h2>Thin?</h2>
<p>Let&#8217;s start at the basics.</p>
<blockquote><p>Thin is a Ruby web server that glues together 3 of the best Ruby libraries in web history.<br /><small> &#8211; <a href="https://code.macournoyer.com/thin/">Thin homepage</a></small></p></blockquote>
<p>The above quote refers to <a href="https://www.zedshaw.com/tips/ragel_state_charts.html">Mongrel</a>, EventMachine and <a href="https://rack.rubyforge.org/">Rack</a>. I am not going cover Mongrel and Rack.</p>
<h2>Up And Running With Thin</h2>
<p>Quickly, let&#8217;s see what it takes to get up and running with Thin.</p>
<p>Create your Rails application.</p>
<pre>rails new thinapp
cd thinapp</pre>
<p>Add the &#8220;thin&#8221; gem to your application.</p>
<pre>echo "gem 'thin'" >> Gemfile
bundle update</pre>
<p>Start your application, running under Thin.</p>
<pre>thin start
<span style="color: #aaa">>> Using rack adapter
>> Thin web server (v1.5.0 codename Knife)
>> Maximum connections set to 1024
>> Listening on 0.0.0.0:3000, CTRL+C to stop</span></pre>
<p>And just like that you are now up and running with Thin and your code is running inside the EventMachine event-loop.</p>
<p><small><a href="https://gist.github.com/3981703" target="gist">Gist of full terminal output</a></small></p>
<h2>Concurrent Requests</h2>
<p>Even if you make no changes to your application, it will receive several benefits.</p>
<p>You can now handle slow clients and large uploads without blocking your Rails application. This is huge! As discussed in part 1 of this EventMachine series, one slow client will hog your whole process if you do not have a proxy server in front of your application for processing slow clients.</p>
<p>Without Thin, your Rails application process will sit there patiently waiting for that one user to upload a 4Gb video using his <a href="https://www.youtube.com/watch?v=X9dpXHnJXaE">1964 antique modem</a>. All your other users will either have to use another Rails process or wait patiently for their turn at dedicated usage of your Rails process.</p>
<p>With Thin, the HTTP requests are multi-plexed. Our single process ignores a request until a chunk of data comes in on that socket. When a chunk of data is received, Thin receives a notification from EventMachine and Thin adds the current chunk of data to the accumulated request. If the request is complete, then your application is passed the complete request. If the request is not complete then we simply wait until another chunk of data to come in from this or other request sockets</p>
<p>This handling of chunks of data from client sockets is very fast. The data is already there when the socket event fires, so the data just needs to be processed. This means that Thin / EventMachine can process a large number chunks of data from many different HTTP request sockets in a small amount of time. We are only CPU-bound here.</p>
<h2>Many Connections == Much Memory</h2>
<p>You might have realized that this multiplexing could become expensive in terms of RAM.</p>
<p>It is great that one guy with a slow modem can upload a large video without affecting your other user requests, but what happens when he uploads 10 videos concurrently? What happens when you have a thousand users all uploading 4Gb videos concurrently?</p>
<p>It is an extreme example, but receiving (1000 x 4Gb) 4 terabytes of data concurrently is going cause you a few headaches. You might have 64Gb of RAM and 500 terabytes of disk space, but if your application does not see those 4Gb requests until we have the full request from Thin, then how are we going to fit all those partially complete requests in RAM at the same time?</p>
<h2>Disk To The Rescue!</h2>
<p>Luckily, Thin uses the local disk as middle-man. If the content-length of a request is over 112Kb then Thin writes the content to a temporary file. As each chunk of data arrives on each HTTP request socket then Thin writes it out to a temporary file rather than keeping it in memory.</p>
<p>This means that your 4Gb request is living on disk instead of in memory, so receiving a thousand 4Gb uploads concurrently now becomes feasible with a single Rails process if we have the network bandwidth to support it and fast enough disks.</p>
<h2>Not Perfect</h2>
<p>My complaint of the spooling requests to disk is that Thin is not doing this in an event-based way.</p>
<p>It looks a little like this&#8230;</p>
<pre>@body = Tempfile.new('thin-body')</pre>
<pre># for each chunk of data received
@body << data
</pre>
<p>Each write of a chunk of request data to disk will block the EventMachine event-loop ("reactor") and the duration of this blocking will depend on your disk IO latency.</p>
<p><a href="https://stackoverflow.com/questions/4645761/how-to-write-large-files-with-ruby-eventmachine">StackOverflow : How to write (large) files with Ruby Eventmachine</a></p>
<h2>Pushing Upstream</h2>
<p>Using Nginx instead of your Rails application to handle slow connections is wise move. Nginx is highly optimized for this and is written in C. If you want to understand how to write highly optimized C code, then browsing through the Nginx code base is for you.</p>
<p>Nginx can spool up requests and pass a more complete HTTP request to your Rails application in one swift transaction. Fewer (bigger) chunks of data being received by your Rails application will result in less concurrency inside your Rails application. This will mean Thin has to do less work. Less work is good and your application's process has more cycles to do the <em>application</em> logic it is designed for.</p>
<p>Nginx, out-of-the-box, will not handle file uploads for you, but there is a <a href="https://www.grid.net.ru/nginx/upload.en.html">module that you can install</a> for that, which simply passes the file path of temporary path to your Rails application.</p>
<h2>EventMachine "Live Edition"</h2>
<p>I mention this here, since Thin version 2 will be using "<a href="https://github.com/ibc/EventMachine-LE">eventmachine-le</a>" instead of "<a href="https://github.com/eventmachine/eventmachine">eventmachine</a>".</p>
<p>See <a href="https://github.com/macournoyer/thin/commit/084197daa0fa7b3d0662679fe4d65c4f6273ecd5">commit 084197d : "Use EM live edition gem."</a></p>
<p>EventMachine-LE is a fork (although it likes to be thought of as a "branch") of EventMachine. It is a drop-in replacement that incorporates many of the pull requests that have been not been merged by the core EventMachine team.</p>
<blockquote><p>This branch incorporates interesting pull requests that are not yet included in the mainline EventMachine repository. The maintainers of that version prefer to minimize change in order to keep the stability with already existing EventMachine deployments, which provides an impressive multi-platform base for IPv4 TCP servers (e.g., Web servers) that don't need good UDP or IPv6 support.<br /><small> - EventMachine-LE README.md</small></p></blockquote>
<p>One of the authors of this is <a href="https://github.com/ibc">Iñaki Baz Castillo</a>, who was also featured in a early blog-post I wrote, <a href="/zero-copy-transfer-data-faster-in-ruby">Zero-Copy. Transfer Data Faster In Ruby</a>.</p>
                  </div><!-- .entry-content -->

        <p class="entry-meta"><span class="category">Posted in <a href="/category/ruby-2/eventmachine" rel="tag">EventMachine</a>, <a href="/category/ruby-2" rel="tag">Ruby</a>, <a href="/category/ruby-on-rails" rel="tag">Ruby On Rails</a></span> <span class="post_tag">| Tagged <a href="/tag/event-based" rel="tag">event-based</a>, <a href="/tag/event-loop" rel="tag">event-loop</a>, <a href="/tag/eventmachine-2" rel="tag">eventmachine</a>, <a href="/tag/rack" rel="tag">rack</a>, <a href="/tag/ruby" rel="tag">ruby</a>, <a href="/tag/ruby-on-rails-2" rel="tag">ruby on rails</a>, <a href="/tag/thin" rel="tag">thin</a>, <a href="/tag/web-server" rel="tag">web server</a>, <a href="/tag/web-development-2" rel="tag">web-development</a></span> | <a class="comments-link" href="/rubys-eventmachine-part-3-thin#comments" title="Comment on Ruby’s EventMachine – Part 3 : Thin">1 Response</a></p>
      </div><!-- .hentry -->

<div id="comments-template">

    <div id="comments">

      <h3 id="comments-number" class="comments-header">One response to &#8220;Ruby’s EventMachine – Part 3 : Thin&#8221;</h3>

      <ol class="comment-list">

  <li id="comment-24689" class="comment even thread-even depth-1 comment reader">

    <img alt='Martinos' src='https://0.gravatar.com/avatar/ed77c0d1c8da409c4f69f67f934ff0bb?s=80&amp;d=https%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=PG' class='avatar avatar-80 photo' height='80' width='80' /><div class="comment-meta comment-meta-data"><div class="comment-author vcard"><cite class="fn">Martinos</cite></div><!-- .comment-author .vcard --> <span class="published"><abbr class="comment-date" title="Friday, November 2nd, 2012, 11:50 am">November 2, 2012</abbr> at <abbr class="comment-time" title="Friday, November 2nd, 2012, 11:50 am">11:50 am</abbr></span>  </div>
    <div class="comment-text">

      <p>Great article,<br />
It&#8217;s the best article that I have found about Thin. In every article that I have read, they say that Thin is faster than many other servers because it uses EventMachine and threads but they never say why. But now I know that it&#8217;s faster for pumping clients requests.</p>
<p>Do you know if it&#8217;s the only une of EventMachine in Thin? if it&#8217;s the case, Nginx + unicorn might be faster that Thin for handling the buffering of http request.</p>
    </div><!-- .comment-text -->

  </li><!-- .comment -->      </ol><!-- .comment-list -->
    </div><!-- #comments -->

</div><!-- #comments-template -->

    <div class="navigation-links">
      <a href="/ab-testing-in-ruby-on-rails" rel="prev"><span class="previous">&laquo; Previous</span></a>          </div><!-- .navigation-links -->

  </div><!-- .content .hfeed -->

  <div id="primary" class="sidebar aside">

        <div id="popularity-lists-1" class="widget widget_popularity_lists widget-widget_popularity_lists"><div class="widget-inside">      <h3 class="widget-title">Top Posts</h3>      <ul>
      <li><a href="/homebrew-intro-to-the-mac-os-x-package-installer">Homebrew - Intro To The Mac OS X Package Installer</a></li><li><a href="/quoras-technology-examined">Quora's Technology Examined</a></li><li><a href="/gitolite-installation-step-by-step">Gitolite Installation Step-By-Step</a></li><li><a href="/how-to-get-experience-working-with-large-datasets">How To Get Experience Working With Large Datasets</a></li><li><a href="/install-gitolite-to-manage-your-git-repositories">Install Gitolite To Manage Your Git Repositories</a></li><li><a href="/embed-base64-encoded-images-inline-in-html">Embed Base64-Encoded Images Inline In HTML</a></li><li><a href="/map-reduce-with-ruby-using-hadoop">Map-Reduce With Ruby Using Hadoop</a></li><li><a href="/highchart-vs-flot-js-comparing-javascript-graphing-engines">Highchart Vs Flot.js - Comparing JavaScript Graphing Engines </a></li>      </ul>
    </div></div><div id="hybrid-tags-2" class="widget tags widget-tags"><div class="widget-inside"><h3 class="widget-title">Tags</h3><p class="post_tag-cloud term-cloud"><a href='/tag/amazon-ec2' class='tag-link-211' title='6 topics' style='font-size: 15.194444444444pt;'>amazon ec2</a> <a href='/tag/android' class='tag-link-74' title='2 topics' style='font-size: 8pt;'>android</a> <a href='/tag/apple' class='tag-link-20' title='3 topics' style='font-size: 10.333333333333pt;'>apple</a> <a href='/tag/cassandra' class='tag-link-204' title='3 topics' style='font-size: 10.333333333333pt;'>cassandra</a> <a href='/tag/customers-2' class='tag-link-148' title='2 topics' style='font-size: 8pt;'>customers</a> <a href='/tag/data-processing-2' class='tag-link-107' title='5 topics' style='font-size: 13.833333333333pt;'>data processing</a> <a href='/tag/entrepreneur' class='tag-link-123' title='2 topics' style='font-size: 8pt;'>entrepreneur</a> <a href='/tag/entrepreneurship' class='tag-link-117' title='2 topics' style='font-size: 8pt;'>entrepreneurship</a> <a href='/tag/eventmachine-2' class='tag-link-422' title='3 topics' style='font-size: 10.333333333333pt;'>eventmachine</a> <a href='/tag/gem' class='tag-link-274' title='3 topics' style='font-size: 10.333333333333pt;'>gem</a> <a href='/tag/git' class='tag-link-177' title='3 topics' style='font-size: 10.333333333333pt;'>git</a> <a href='/tag/gitolite' class='tag-link-178' title='2 topics' style='font-size: 8pt;'>gitolite</a> <a href='/tag/google' class='tag-link-89' title='2 topics' style='font-size: 8pt;'>google</a> <a href='/tag/hadoop' class='tag-link-102' title='7 topics' style='font-size: 16.166666666667pt;'>hadoop</a> <a href='/tag/hbase' class='tag-link-264' title='4 topics' style='font-size: 12.277777777778pt;'>hbase</a> <a href='/tag/hdfs' class='tag-link-103' title='4 topics' style='font-size: 12.277777777778pt;'>hdfs</a> <a href='/tag/high-scalability' class='tag-link-114' title='3 topics' style='font-size: 10.333333333333pt;'>high scalability</a> <a href='/tag/homebrew' class='tag-link-216' title='4 topics' style='font-size: 12.277777777778pt;'>homebrew</a> <a href='/tag/install' class='tag-link-51' title='2 topics' style='font-size: 8pt;'>install</a> <a href='/tag/iphone' class='tag-link-65' title='2 topics' style='font-size: 8pt;'>iphone</a> <a href='/tag/java' class='tag-link-276' title='3 topics' style='font-size: 10.333333333333pt;'>java</a> <a href='/tag/location' class='tag-link-136' title='2 topics' style='font-size: 8pt;'>location</a> <a href='/tag/mac-osx' class='tag-link-59' title='2 topics' style='font-size: 8pt;'>mac osx</a> <a href='/tag/memcached' class='tag-link-306' title='4 topics' style='font-size: 12.277777777778pt;'>memcached</a> <a href='/tag/mongodb' class='tag-link-210' title='5 topics' style='font-size: 13.833333333333pt;'>mongodb</a> <a href='/tag/mysql' class='tag-link-293' title='3 topics' style='font-size: 10.333333333333pt;'>mysql</a> <a href='/tag/nginx' class='tag-link-326' title='4 topics' style='font-size: 12.277777777778pt;'>nginx</a> <a href='/tag/nosql' class='tag-link-205' title='6 topics' style='font-size: 15.194444444444pt;'>nosql</a> <a href='/tag/perl' class='tag-link-377' title='3 topics' style='font-size: 10.333333333333pt;'>perl</a> <a href='/tag/phone' class='tag-link-72' title='3 topics' style='font-size: 10.333333333333pt;'>phone</a> <a href='/tag/postgresql' class='tag-link-221' title='3 topics' style='font-size: 10.333333333333pt;'>postgresql</a> <a href='/tag/python' class='tag-link-355' title='5 topics' style='font-size: 13.833333333333pt;'>python</a> <a href='/tag/rails' class='tag-link-172' title='2 topics' style='font-size: 8pt;'>rails</a> <a href='/tag/redis' class='tag-link-301' title='3 topics' style='font-size: 10.333333333333pt;'>redis</a> <a href='/tag/ruby' class='tag-link-166' title='15 topics' style='font-size: 22pt;'>ruby</a> <a href='/tag/ruby-on-rails-2' class='tag-link-157' title='6 topics' style='font-size: 15.194444444444pt;'>ruby on rails</a> <a href='/tag/scala' class='tag-link-302' title='3 topics' style='font-size: 10.333333333333pt;'>scala</a> <a href='/tag/ssh-keygen' class='tag-link-180' title='2 topics' style='font-size: 8pt;'>ssh-keygen</a> <a href='/tag/startup' class='tag-link-119' title='3 topics' style='font-size: 10.333333333333pt;'>startup</a> <a href='/tag/tornado' class='tag-link-330' title='6 topics' style='font-size: 15.194444444444pt;'>tornado</a> <a href='/tag/twitter' class='tag-link-133' title='2 topics' style='font-size: 8pt;'>twitter</a> <a href='/tag/vancouver' class='tag-link-120' title='2 topics' style='font-size: 8pt;'>vancouver</a> <a href='/tag/web-development-2' class='tag-link-193' title='5 topics' style='font-size: 13.833333333333pt;'>web-development</a> <a href='/tag/whirr' class='tag-link-223' title='3 topics' style='font-size: 10.333333333333pt;'>whirr</a> <a href='/tag/wikipedia' class='tag-link-174' title='2 topics' style='font-size: 8pt;'>wikipedia</a></p></div></div>

  </div><!-- #primary .aside -->

  </div><!-- #container -->

<div id="footer">Copyright &#169; 2016 <a href="/">Big Fast Blog</a> | Vancouver, BC, Canada</div>

</div><!-- #body-container -->

</body>
</html>
